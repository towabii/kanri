<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ç®¡ç†ãƒ‘ãƒãƒ«</title>

<style>
    /* --- CSS Reset & Base --- */
    :root {
        --bg-body: #f4f6f8;
        --bg-sidebar: #1e293b;
        --sidebar-width: 250px;
        --accent-color: #3b82f6;
        --accent-hover: #2563eb;
        --text-main: #334155;
        --text-sub: #64748b;
        --card-radius: 12px;
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        --border-color: #e2e8f0;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background-color: var(--bg-body); font-family: "Helvetica Neue", Arial, sans-serif; color: var(--text-main); font-size: 14px; line-height: 1.5; }
    
    /* --- Layout Utilities --- */
    .d-none { display: none !important; }
    .d-flex { display: flex; }
    .flex-column { flex-direction: column; }
    .justify-between { justify-content: space-between; }
    .align-center { align-items: center; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 1rem; }
    .w-100 { width: 100%; }
    .text-center { text-align: center; }
    .text-end { text-align: right; }
    .fw-bold { font-weight: 700; }
    .text-muted { color: var(--text-sub); }
    .text-primary { color: var(--accent-color); }
    .text-danger { color: #ef4444; }
    .mt-3 { margin-top: 1rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 1rem; }
    .mb-4 { margin-bottom: 1.5rem; }
    .p-3 { padding: 1rem; }
    .p-4 { padding: 1.5rem; }

    /* --- Grid System (Simplified) --- */
    .row { display: flex; flex-wrap: wrap; margin: -10px; }
    .col { flex: 1; padding: 10px; }
    .col-3 { width: 25%; padding: 10px; }
    .col-6 { width: 50%; padding: 10px; }
    .col-12 { width: 100%; padding: 10px; }
    @media (max-width: 992px) {
        .col-3, .col-6 { width: 50%; }
        .sidebar { display: none; }
        .main-content { margin-left: 0 !important; padding-bottom: 80px; }
        .bottom-nav { display: flex !important; }
    }
    @media (max-width: 600px) {
        .col-3, .col-6 { width: 100%; }
    }

    /* --- Components --- */
    .app-container { display: flex; min-height: 100vh; }
    
    /* Sidebar */
    .sidebar {
        width: var(--sidebar-width); background: var(--bg-sidebar); color: #94a3b8;
        position: fixed; top: 0; bottom: 0; left: 0; z-index: 1000;
        display: flex; flex-direction: column; padding: 1.5rem 1rem;
    }
    .sidebar-brand { font-size: 1.25rem; font-weight: 700; color: #fff; margin-bottom: 2rem; }
    .nav-header { font-size: 0.75rem; text-transform: uppercase; color: #64748b; margin: 1.5rem 0 0.5rem 0.5rem; font-weight: bold; }
    .nav-link {
        display: block; color: inherit; padding: 0.75rem 1rem; border-radius: 8px; 
        text-decoration: none; margin-bottom: 4px; transition: 0.2s; cursor: pointer;
    }
    .nav-link:hover { background: rgba(255,255,255,0.08); color: #fff; }
    .nav-link.active { background: var(--accent-color); color: #fff; }

    /* Main Content */
    .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 2rem; width: 100%; }

    /* Cards */
    .card-panel {
        background: #fff; border-radius: var(--card-radius); box-shadow: var(--card-shadow);
        height: 100%; overflow: hidden; display: flex; flex-direction: column;
    }
    .panel-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
    .panel-body { padding: 1.5rem; flex: 1; }

    /* Stats */
    .stat-card {
        background: #fff; padding: 1.25rem; border-radius: var(--card-radius);
        box-shadow: var(--card-shadow); display: flex; justify-content: space-between; align-items: center;
    }
    .stat-val { font-size: 1.8rem; font-weight: 700; color: #1e293b; }
    .stat-label { font-size: 0.8rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; }

    /* Forms */
    .form-control, .form-select {
        width: 100%; padding: 0.6rem 0.8rem; font-size: 0.9rem;
        border: 1px solid #ced4da; border-radius: 6px; transition: 0.2s; margin-bottom: 0.5rem;
    }
    .form-control:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
    
    /* Buttons */
    .btn {
        display: inline-block; padding: 0.6rem 1.2rem; border-radius: 6px; border: none;
        cursor: pointer; font-size: 0.9rem; font-weight: 500; text-align: center; transition: 0.2s;
    }
    .btn-primary { background: var(--accent-color); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-outline { background: transparent; border: 1px solid #ccc; color: var(--text-main); }
    .btn-dark { background: #1e293b; color: white; }
    .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
    .w-100 { width: 100%; }

    /* Tables */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; text-align: left; }
    th { background: #f8fafc; color: var(--text-sub); font-weight: 600; padding: 0.8rem; border-bottom: 1px solid var(--border-color); font-size: 0.8rem; white-space: nowrap;}
    td { padding: 0.8rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
    tr:hover td { background-color: #f8fafc; cursor: pointer; }

    /* Badges */
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; border: 1px solid #eee; }
    .badge.online { background: #dcfce7; color: #166534; }
    .badge.offline { background: #f1f5f9; color: #64748b; }
    .badge.ban { background: #fee2e2; color: #991b1b; }

    /* Mobile Nav */
    .bottom-nav {
        display: none; position: fixed; bottom: 0; left: 0; right: 0; height: 60px;
        background: #fff; border-top: 1px solid var(--border-color); z-index: 2000;
        justify-content: space-around; align-items: center;
    }
    .b-nav-item { flex: 1; text-align: center; color: #94a3b8; font-size: 0.7rem; cursor: pointer; }
    .b-nav-item.active { color: var(--accent-color); font-weight: bold; }
    .b-nav-icon { display: block; font-size: 1.2rem; margin-bottom: 2px; }

    /* Modal */
    .modal-overlay {
        display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5);
        z-index: 3000; justify-content: center; align-items: center;
    }
    .modal-overlay.active { display: flex; }
    .modal-box {
        background: #fff; width: 90%; max-width: 600px; max-height: 90vh;
        border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-header { padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 1.5rem; overflow-y: auto; }
    .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; line-height: 1; }

    /* Login & Loading */
    #loading { position: fixed; inset:0; background: rgba(255,255,255,0.9); z-index: 9999; display:none; justify-content: center; align-items: center; flex-direction: column; }
    #login-screen { position: fixed; inset: 0; background: #f1f5f9; z-index: 3000; display: flex; justify-content: center; align-items: center; }
    .login-box { background: #fff; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 300px; text-align: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Custom Chart */
    canvas { width: 100% !important; height: 250px !important; }
    .timeline-item { padding-left: 15px; border-left: 2px solid #e2e8f0; margin-left: 5px; padding-bottom: 15px; position: relative; }
    .timeline-item::before { content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; background: #fff; border: 2px solid var(--accent-color); border-radius: 50%; }
</style>

</head>
<body>

<!-- Loading -->
<div id="loading">
    <div class="spinner"></div>
    <div style="font-weight:bold; color:#666;">ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸä¸­...</div>
</div>

<!-- Login -->
<div id="login-screen">
    <div class="login-box">
        <div style="font-size:3rem; margin-bottom:1rem;">ğŸ›¡ï¸</div>
        <h3 class="fw-bold mb-2">ç®¡ç†ãƒ‘ãƒãƒ«</h3>
        <p class="text-muted mb-4" style="font-size:0.8rem;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›</p>
        <input type="password" id="loginPass" class="form-control text-center mb-3" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button class="btn btn-primary w-100" onclick="manualLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div id="loginMsg" class="mt-3 text-danger" style="font-size:0.8rem; font-weight:bold;"></div>
    </div>
</div>

<!-- App -->
<div class="app-container" id="app-main" style="display:none;">

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-brand">ğŸ“Š ç®¡ç†ãƒ‘ãƒãƒ«</div>
        
        <div class="nav-header">ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
        <a class="nav-link active" onclick="switchTab('dashboard')">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
        <a class="nav-link" onclick="switchTab('users')">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
        <a class="nav-link" onclick="switchTab('feedback')">ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</a>

        <div class="nav-header">è¨­å®šãƒ»ç®¡ç†</div>
        <a class="nav-link" onclick="switchTab('notification')">ğŸ“¢ ãŠçŸ¥ã‚‰ã›è¨­å®š</a>
        <a class="nav-link" onclick="switchTab('survey')">ğŸ“ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¨­å®š</a>

        <div class="nav-header">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</div>
        <a class="nav-link" onclick="switchTab('updates')">ğŸ”„ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</a>
        <a class="nav-link" onclick="switchTab('schedule')">ğŸ“… äºˆå®šç®¡ç†</a>

        <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <button class="btn btn-outline w-100" style="color:#ccc; border-color:#555;" onclick="logout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

        <!-- DASHBOARD -->
        <div id="view-dashboard" class="view-section">
            <div class="d-flex justify-between align-center mb-4">
                <div>
                    <h2 class="fw-bold">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                    <small class="text-muted">ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®çŠ¶æ³</small>
                </div>
                <span class="badge" style="background:#fff;" id="last-upd">Syncing...</span>
            </div>
            
            <div class="row mb-4">
                <div class="col-3">
                    <div class="stat-card">
                        <div><div class="stat-label">ç¾åœ¨ã®æ¥ç¶š</div><div class="stat-val text-primary" id="d-online">-</div></div>
                        <div style="font-size:1.5rem">ğŸ“¡</div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="stat-card">
                        <div><div class="stat-label">ç·ãƒ¦ãƒ¼ã‚¶ãƒ¼</div><div class="stat-val" id="d-users">-</div></div>
                        <div style="font-size:1.5rem">ğŸ‘¥</div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="stat-card">
                        <div><div class="stat-label">å—ä¿¡ç®±</div><div class="stat-val" id="d-feedbacks">-</div></div>
                        <div style="font-size:1.5rem">ğŸ“©</div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="stat-card">
                        <div><div class="stat-label">å›ç­”æ•°</div><div class="stat-val" id="d-answers">-</div></div>
                        <div style="font-size:1.5rem">ğŸ“Š</div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-6" style="flex:2;">
                    <div class="card-panel">
                        <div class="panel-header">ğŸ“ˆ æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨ç§» (ç›´è¿‘6ãƒ¶æœˆ)</div>
                        <div class="panel-body">
                            <!-- ç°¡æ˜“Canvasãƒãƒ£ãƒ¼ãƒˆ -->
                            <canvas id="userChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-6" style="flex:1;">
                    <div class="card-panel">
                        <div class="panel-header">
                            <span>ğŸ† äººæ°—ã‚¢ãƒ—ãƒª</span>
                            <span class="badge" id="rank-month">-æœˆ</span>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead style="background:#f8fafc"><tr><th>#</th><th>ã‚¿ã‚¤ãƒˆãƒ«</th><th class="text-end">å›æ•°</th></tr></thead>
                                <tbody id="d-ranking-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-panel">
                <div class="panel-header">âš¡ æœ€æ–°ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</div>
                <div class="panel-body" id="timeline-feed"></div>
            </div>
        </div>

        <!-- NOTIFICATION -->
        <div id="view-notification" class="view-section d-none">
            <h2 class="fw-bold mb-4">ãŠçŸ¥ã‚‰ã›è¨­å®š</h2>
            <div class="row" style="justify-content: center;">
                <div class="col-12" style="max-width: 800px;">
                    <div class="card-panel">
                        <div class="panel-body">
                            <div class="d-flex justify-between align-center mb-4" style="border-bottom:1px solid #eee; padding-bottom:1rem;">
                                <div><h4 class="fw-bold">ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º</h4><small class="text-muted">è¨ªå•æ™‚ã«è¡¨ç¤ºã™ã‚‹</small></div>
                                <input type="checkbox" id="n-active" style="width:20px; height:20px;">
                            </div>
                            <div class="mb-3">
                                <label class="fw-bold mb-2 d-block">ã‚¿ã‚¤ãƒˆãƒ«</label>
                                <input type="text" id="n-title" class="form-control" placeholder="ä¾‹: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›">
                            </div>
                            <div class="mb-4">
                                <label class="fw-bold mb-2 d-block">æœ¬æ–‡ (<span class="text-danger">#æ–‡å­—#</span>ã§èµ¤è‰²å¼·èª¿)</label>
                                <textarea id="n-text" rows="6" class="form-control" placeholder="æœ¬æ–‡..."></textarea>
                            </div>
                            <button class="btn btn-primary w-100" onclick="saveNotify()">è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SURVEY -->
        <div id="view-survey" class="view-section d-none">
            <h2 class="fw-bold mb-4">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆè¨­å®š</h2>
            <div class="row">
                <div class="col-6">
                    <div class="card-panel mb-3">
                        <div class="panel-header">æ–°è¦ä½œæˆ</div>
                        <div class="panel-body">
                            <div class="mb-3 text-danger" style="font-size:0.85rem;">âš ï¸ å…¬é–‹ã™ã‚‹ã¨ä»¥å‰ã®çµæœã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</div>
                            <label class="fw-bold mb-2 d-block">è³ªå•æ–‡</label>
                            <input type="text" id="sv-q" class="form-control mb-3" placeholder="ä¾‹: ã‚µã‚¤ãƒˆã®ä½¿ã„ã‚„ã™ã•ã¯ï¼Ÿ">
                            <label class="fw-bold mb-2 d-block">é¸æŠè‚¢ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                            <input type="text" id="sv-o" class="form-control mb-4" placeholder="ä¾‹: è‰¯ã„,æ™®é€š,æ‚ªã„">
                            <button class="btn btn-dark w-100" onclick="pubSurvey()">å…¬é–‹ã™ã‚‹</button>
                        </div>
                    </div>
                    <div class="card-panel">
                        <div class="panel-header">ç¾åœ¨ã®è¨­å®š</div>
                        <div class="panel-body">
                            <div class="text-muted mb-1">è³ªå•:</div>
                            <div id="sv-cur-q" class="fw-bold mb-3">-</div>
                            <div class="text-muted mb-1">é¸æŠè‚¢:</div>
                            <div id="sv-cur-o" class="badge bg-light" style="display:inline-block">-</div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card-panel h-100">
                        <div class="panel-header">é›†è¨ˆçµæœ</div>
                        <div class="panel-body" id="sv-result-area"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- USERS -->
        <div id="view-users" class="view-section d-none">
            <div class="d-flex justify-between align-center mb-3">
                <h2 class="fw-bold">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
                <span class="badge" id="u-total">0 Users</span>
            </div>
            <div class="card-panel p-3 mb-3">
                <input type="text" id="u-search" class="form-control" placeholder="ğŸ” ID, åå‰, ãƒ¡ãƒ¢ã§æ¤œç´¢..." onkeyup="filterU()">
            </div>
            <div class="card-panel">
                <div class="table-container">
                    <table class="table">
                        <thead><tr><th>çŠ¶æ…‹</th><th>ID / åå‰</th><th>æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹</th><th>ãƒ¡ãƒ¢</th><th class="text-end">æ“ä½œ</th></tr></thead>
                        <tbody id="u-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- FEEDBACK -->
        <div id="view-feedback" class="view-section d-none">
            <h2 class="fw-bold mb-3">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h2>
            <div class="card-panel">
                <div class="table-container">
                    <table class="table">
                        <thead><tr><th>æ—¥æ™‚</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼</th><th>ç¨®é¡</th><th>å†…å®¹</th></tr></thead>
                        <tbody id="fb-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- UPDATES & SCHEDULE -->
        <div id="view-updates" class="view-section d-none">
            <h2 class="fw-bold mb-3">ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ±</h2>
            <div class="card-panel p-4 mb-4">
                <h4 class="fw-bold mb-3">æ–°è¦è¿½åŠ </h4>
                <div class="row">
                    <div class="col"><input id="up-v" class="form-control" placeholder="Ver (v1.0)"></div>
                    <div class="col"><input id="up-d" class="form-control" placeholder="æ—¥ä»˜"></div>
                </div>
                <input id="up-t" class="form-control" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
                <input id="up-vid" class="form-control" placeholder="å‹•ç”»URL">
                <textarea id="up-det" class="form-control" placeholder="è©³ç´° (æ”¹è¡Œã§ç®‡æ¡æ›¸ã)"></textarea>
                <button class="btn btn-dark w-100 mt-3" onclick="addUp()">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
            </div>
            <div class="card-panel">
                <div class="table-container">
                    <table class="table"><tbody id="up-body"></tbody></table>
                </div>
            </div>
        </div>

        <div id="view-schedule" class="view-section d-none">
            <h2 class="fw-bold mb-3">äºˆå®šç®¡ç†</h2>
            <div class="row">
                <div class="col-6">
                    <div class="card-panel p-4">
                        <h4 class="fw-bold mb-3">äºˆå®šã‚’è¿½åŠ </h4>
                        <label>é …ç›®å</label><input id="sc-n" class="form-control">
                        <label>æ—¥ä»˜</label><input id="sc-d" class="form-control">
                        <button class="btn btn-dark w-100 mt-3" onclick="addSc()">è¿½åŠ </button>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card-panel">
                        <table class="table"><tbody id="sc-body"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Bottom Nav (Mobile) -->
<div class="bottom-nav">
    <div class="b-nav-item active" onclick="switchTab('dashboard', this)"><span class="b-nav-icon">ğŸ </span>ãƒ›ãƒ¼ãƒ </div>
    <div class="b-nav-item" onclick="switchTab('users', this)"><span class="b-nav-icon">ğŸ‘¥</span>ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
    <div class="b-nav-item" onclick="switchTab('feedback', this)"><span class="b-nav-icon">ğŸ’¬</span>å—ä¿¡ç®±</div>
    <div class="b-nav-item" onclick="switchTab('survey', this)"><span class="b-nav-icon">ğŸ“</span>æŠ•ç¥¨</div>
</div>

<!-- Modal: User Detail -->
<div class="modal-overlay" id="uModal">
    <div class="modal-box">
        <div class="modal-header">
            <div class="fw-bold">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°</div>
            <button class="close-btn" onclick="closeModal('uModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="d-flex align-center gap-3 mb-4">
                <div style="width:50px; height:50px; background:var(--accent-color); color:white; border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:1.5rem;" id="m-av">U</div>
                <div>
                    <div class="fw-bold" style="font-size:1.1rem;" id="m-uid">ID</div>
                    <div class="text-muted" id="m-aka">No Name</div>
                </div>
                <div id="m-status" style="margin-left:auto;"></div>
            </div>

            <div class="row text-center mb-4" style="background:#f8fafc; padding:10px; border-radius:8px;">
                <div class="col">
                    <small class="text-muted d-block">åˆå›</small>
                    <strong id="m-first">-</strong>
                </div>
                <div class="col">
                    <small class="text-muted d-block">ãƒ—ãƒ¬ã‚¤å›æ•°</small>
                    <strong id="m-plays">0</strong>
                </div>
                <div class="col">
                    <small class="text-muted d-block">çŠ¶æ…‹</small>
                    <strong id="m-ban-badge">-</strong>
                </div>
            </div>

            <div class="mb-3">
                <label class="fw-bold mb-1 d-block">ç®¡ç†è€…ãƒ¡ãƒ¢</label>
                <input id="m-memo" class="form-control" placeholder="ãƒ¡ãƒ¢...">
            </div>
            <div class="mb-3">
                <label class="fw-bold mb-1 d-block">BANè¨­å®š (ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦)</label>
                <select id="m-ban" class="form-select">
                    <option value="FALSE">æ­£å¸¸ (ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯)</option>
                    <option value="TRUE">BAN (ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦)</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="fw-bold mb-1 d-block">å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                <input id="m-msg" class="form-control" placeholder="æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«è¡¨ç¤º">
            </div>
            <button class="btn btn-dark w-100 mb-4" onclick="saveU()">è¨­å®šã‚’ä¿å­˜</button>

            <hr class="mb-3">
            <div class="row">
                <div class="col-6">
                    <h5 class="fw-bold mb-2">ã‚ˆãéŠã¶ã‚²ãƒ¼ãƒ </h5>
                    <ul id="m-games" style="list-style:none; padding:0; font-size:0.9rem;"></ul>
                </div>
                <div class="col-6">
                    <h5 class="fw-bold mb-2">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å±¥æ­´</h5>
                    <div id="m-fb" style="font-size:0.8rem; color:#555;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Bulk Send -->
<div class="modal-overlay" id="bModal">
    <div class="modal-box" style="max-width:400px;">
        <div class="modal-header">
            <div class="fw-bold">ä¸€æ–‰é€ä¿¡</div>
            <button class="close-btn" onclick="closeModal('bModal')">Ã—</button>
        </div>
        <div class="modal-body text-center">
            <div style="font-size:2rem; margin-bottom:1rem;">ğŸ“¨</div>
            <p class="mb-3">
                å›ç­”ã€Œ<strong id="b-ans"></strong>ã€ã®<br>
                <strong id="b-cnt" style="font-size:1.2rem;"></strong> åã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã™ã€‚
            </p>
            <input id="b-msg" class="form-control mb-3" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…å®¹...">
            <div class="d-flex gap-2">
                <button class="btn btn-outline w-100" onclick="closeModal('bModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary w-100" onclick="execBulk()">é€ä¿¡</button>
            </div>
        </div>
    </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzJSO_Bq80Qc1UI8RNyKBJ2Az81QfFkqdO-0j9nLglrEkirg-69sxYfPdGMbq9l30AO/exec";
let auth="", data=null, timer=null, curU=null, bulkIds=[];

const loading=(s)=>document.getElementById("loading").style.display=s?"flex":"none";
const closeModal=(id)=>document.getElementById(id).classList.remove("active");
const openModal=(id)=>document.getElementById(id).classList.add("active");

document.addEventListener("DOMContentLoaded",()=>{
    const k=localStorage.getItem("admKey");
    if(k){ auth=k; loading(true); fetchD().then(ok=>{ loading(false); if(ok)init(); else{ localStorage.removeItem("admKey"); document.getElementById("login-screen").style.display="flex"; } }); }
    else document.getElementById("login-screen").style.display="flex";
});

function manualLogin(){
    const p=document.getElementById("loginPass").value; if(!p)return;
    auth=p; loading(true); fetchD().then(ok=>{ loading(false); if(ok){ localStorage.setItem("admKey",p); init(); } else document.getElementById("loginMsg").innerText="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"; });
}

function init(){
    document.getElementById("login-screen").style.display="none";
    document.getElementById("app-main").style.display="flex";
    if(window.innerWidth<=992) document.querySelector(".bottom-nav").style.display="flex";
    start();
}
function start(){ if(timer)clearInterval(timer); timer=setInterval(()=>{ if(!document.querySelector('.modal-overlay.active')) fetchD(); },15000); }

async function fetchD(){
    try{
        const r=await fetch(API,{ method:"POST", body:JSON.stringify({ action:"adminGetData", payload:{ password:auth } }) });
        const j=await r.json();
        if(j.status==="success"){ data=j.data; render(); return true; }
        return false;
    }catch(e){ console.error(e); return false; }
}

function render(){
    if(!data)return;
    const now=Date.now(); const thres=10*60*1000;
    
    // Stats
    let on=0; data.users.forEach(u=>{ if(u[2]&&now-new Date(u[2]).getTime()<thres)on++; });
    document.getElementById("d-online").innerText=on;
    document.getElementById("d-users").innerText=data.users.length;
    document.getElementById("d-feedbacks").innerText=data.feedback.length;
    document.getElementById("d-answers").innerText=data.surveyResponses.length;
    document.getElementById("u-total").innerText=data.users.length+" Users";
    const dt=new Date();
    document.getElementById("last-upd").innerText = dt.getHours()+":"+String(dt.getMinutes()).padStart(2,'0');

    drawSimpleChart();
    renderRank();
    renderTime();
    
    // Configs
    document.getElementById("n-active").checked=(data.config.notificationActive==="TRUE");
    document.getElementById("n-title").value=data.config.notificationTitle||"";
    document.getElementById("n-text").value=(data.config.notificationText||"").replaceAll("<br>","\n");
    const q=data.config.surveyQuestion||"(æœªè¨­å®š)";
    document.getElementById("sv-cur-q").innerText=q;
    document.getElementById("sv-cur-o").innerText=data.config.surveyOptions||"-";
    renderSv(q);

    // Users & Feed
    renderU(thres, now);
    const fbBody = document.getElementById("fb-body"); fbBody.innerHTML="";
    [...data.feedback].reverse().forEach(f=>{
        const uid=f[1], name=f[2];
        const uObj = data.users.find(u=>u[0]===uid);
        const isOn = uObj && uObj[2] ? (now - new Date(uObj[2]).getTime() < thres) : false;
        const tr=document.createElement("tr"); 
        tr.onclick=()=>openU(uid, name, isOn);
        tr.innerHTML=`<td class="text-muted">${f[0].slice(5,16)}</td><td><strong>${name}</strong><br><small>${uid}</small></td><td><span class='badge'>${f[3]}</span></td><td>${f[7]}</td>`;
        fbBody.appendChild(tr);
    });

    renderSimple("up-body", data.updates, (r,i)=>`<td><strong>${r[0]}</strong></td><td>${r[1]}</td><td>${r[2]}</td><td class='text-end'><button class='btn btn-outline text-danger' onclick='del("Updates",${i})'>å‰Šé™¤</button></td>`);
    renderSimple("sc-body", data.schedule, (r,i)=>`<td><strong>${r[0]}</strong></td><td>${r[1]}</td><td class='text-end'><button class='btn btn-outline text-danger' onclick='del("Schedule",${i})'>å‰Šé™¤</button></td>`);
}

// Custom Chart (Canvas) - Replaces Chart.js
function drawSimpleChart(){
    const canvas = document.getElementById('userChart');
    const ctx = canvas.getContext('2d');
    const width = canvas.width = canvas.offsetWidth;
    const height = canvas.height = canvas.offsetHeight;
    
    // Data Prep
    const counts={}; const d=new Date(); d.setDate(1); 
    const labels=[]; 
    for(let i=5; i>=0; i--){
        const temp=new Date(d); temp.setMonth(d.getMonth()-i);
        labels.push(`${temp.getFullYear()}-${String(temp.getMonth()+1).padStart(2,'0')}`);
    }
    data.users.forEach(u=>{ 
        if(u[1]){
            const k=u[1].substring(0,7); // YYYY-MM
            counts[k]=(counts[k]||0)+1;
        }
    });
    const values = labels.map(k=>counts[k]||0);
    const maxVal = Math.max(...values, 5);

    // Draw
    ctx.clearRect(0,0,width,height);
    const padL=30, padB=30;
    const chartW = width-padL; const chartH = height-padB;

    // Grid
    ctx.strokeStyle="#e2e8f0"; ctx.lineWidth=1; ctx.beginPath();
    ctx.moveTo(padL,0); ctx.lineTo(padL,chartH); ctx.lineTo(width,chartH);
    ctx.stroke();

    // Plot Line
    ctx.strokeStyle="#3b82f6"; ctx.lineWidth=3; ctx.beginPath();
    const stepX = chartW / (labels.length-1);
    values.forEach((v,i)=>{
        const x = padL + i*stepX;
        const y = chartH - (v/maxVal)*chartH;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        // Draw Dot
        ctx.fillStyle="#3b82f6"; ctx.fillRect(x-3, y-3, 6, 6);
    });
    ctx.stroke();

    // Labels
    ctx.fillStyle="#64748b"; ctx.font="10px Arial"; ctx.textAlign="center";
    labels.forEach((l,i)=>{ ctx.fillText(l.slice(5), padL + i*stepX, height-10); });
}

function renderRank(){
    const now=new Date(); const checkY=now.getFullYear(); const checkM=now.getMonth()+1;
    const cnt={}; data.playLogs.forEach(l=>{
        const d = new Date(l[0].replace(/\//g, '-'));
        if(d.getFullYear()===checkY && (d.getMonth()+1)===checkM) cnt[l[2]]=(cnt[l[2]]||0)+1;
    });
    const s=Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const tb=document.getElementById("d-ranking-body"); tb.innerHTML="";
    document.getElementById("rank-month").innerText = `${checkM}æœˆ`;
    if(!s.length) tb.innerHTML="<tr><td colspan='3' class='text-center p-3'>ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>";
    else s.forEach((x,i)=> tb.innerHTML+=`<tr><td class='fw-bold'>${i+1}</td><td>${x[0]}</td><td class='text-end'>${x[1]}</td></tr>`);
}

function renderTime(){
    let feed=[];
    data.users.forEach(u=>feed.push({t:new Date(u[1]).getTime(), u:u[0], txt:"æ–°è¦ç™»éŒ²"}));
    data.feedback.forEach(f=>feed.push({t:new Date(f[0]).getTime(), u:f[1], txt:`FB: ${f[3]}`}));
    data.playLogs.forEach(p=>feed.push({t:new Date(p[0]).getTime(), u:p[1], txt:`Game: ${p[2]}`}));
    feed.sort((a,b)=>b.t-a.t);
    const el=document.getElementById("timeline-feed"); el.innerHTML="";
    feed.slice(0,10).forEach(x=>{
        const d=new Date(x.t);
        el.innerHTML+=`<div class="timeline-item"><div class="text-muted" style="font-size:0.75rem">${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}</div><div><strong style="color:#333">${x.u}</strong> <span class="text-muted">${x.txt}</span></div></div>`;
    });
}

function renderU(thres, now){
    const tb=document.getElementById("u-tbody"); tb.innerHTML="";
    const nMap={}; data.feedback.forEach(f=>nMap[f[1]]=f[2]);
    
    [...data.users].reverse().forEach(u=>{
        const uid=u[0], memo=u[5]||"", name=nMap[uid]||"åç„¡ã—";
        const isBan=(String(u[3]).toUpperCase()==="TRUE");
        const isOn=(u[2] && now-new Date(u[2]).getTime() < thres);
        const status = isBan ? `<span class="badge ban">BAN</span>` : (isOn ? `<span class="badge online">Online</span>` : `<span class="badge offline">Offline</span>`);
        
        const tr=document.createElement("tr"); tr.className="user-row"; tr.dataset.s=(uid+name+memo).toLowerCase();
        tr.onclick=()=>openU(uid, name, isOn);
        tr.innerHTML=`<td>${status}</td><td><strong>${name}</strong><br><small>${uid}</small></td><td>${u[2]?u[2].slice(5,16):'-'}</td><td style="max-width:100px; overflow:hidden; white-space:nowrap;">${memo}</td><td class="text-end"><button class="btn btn-outline btn-sm">è©³ç´°</button></td>`;
        tb.appendChild(tr);
    });
    filterU();
}

function filterU(){
    const t=document.getElementById("u-search").value.toLowerCase();
    document.querySelectorAll(".user-row").forEach(r=>r.style.display=r.dataset.s.includes(t)?"":"none");
}

function renderSv(q){
    const el=document.getElementById("sv-result-area"); el.innerHTML="";
    if(!q||q==="(æœªè¨­å®š)"){ el.innerHTML="<div class='text-muted p-3'>ãƒ‡ãƒ¼ã‚¿ãªã—</div>"; return; }
    const cnt={}; const ids={}; let tot=0;
    data.surveyResponses.forEach(r=>{ if(r[3]===q){ cnt[r[4]]=(cnt[r[4]]||0)+1; tot++; if(!ids[r[4]])ids[r[4]]=[]; ids[r[4]].push(r[1]); } });
    
    Object.keys(cnt).forEach(ans=>{
        const p=Math.round(cnt[ans]/tot*100);
        const div=document.createElement("div"); div.className="mb-3";
        div.innerHTML=`<div class="d-flex justify-between mb-1"><span>${ans}</span><span>${cnt[ans]} (${p}%)</span></div><div style="background:#f1f5f9; height:8px; border-radius:4px;"><div style="width:${p}%; background:#3b82f6; height:100%; border-radius:4px;"></div></div><button class="btn btn-outline btn-sm mt-2" onclick="bulk('${ans}',${cnt[ans]})">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</button>`;
        div.querySelector("button").onclick=()=>bulk(ans,cnt[ans],ids[ans]);
        el.appendChild(div);
    });
}

function renderSimple(id, arr, fn){
    const el=document.getElementById(id); el.innerHTML="";
    arr.forEach((r,i)=>{ const tr=document.createElement("tr"); tr.innerHTML=fn(r,i); el.appendChild(tr); });
}

async function post(a,p){ loading(true); p.password=auth; try{ await fetch(API,{method:"POST",body:JSON.stringify({action:a,payload:p})}); await fetchD(); }catch(e){} loading(false); }

function openU(uid, name, isOn){
    curU=uid; const u=data.users.find(x=>x[0]===uid);
    document.getElementById("m-uid").innerText=uid; document.getElementById("m-aka").innerText=name;
    document.getElementById("m-av").innerText=name.charAt(0);
    document.getElementById("m-status").innerHTML = (String(u[3]).toUpperCase()==="TRUE") ? '<span class="badge ban">BANä¸­</span>' : (isOn?'<span class="badge online">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>':'<span class="badge offline">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>');
    document.getElementById("m-first").innerText = u[1] ? u[1].slice(0,10) : "-";
    document.getElementById("m-ban-badge").innerText = (String(u[3]).toUpperCase()==="TRUE") ? "åˆ¶é™ã‚ã‚Š" : "æ­£å¸¸";
    document.getElementById("m-memo").value = u[5]||"";
    document.getElementById("m-ban").value = (String(u[3]).toUpperCase()==="TRUE")?"TRUE":"FALSE";
    document.getElementById("m-msg").value = u[4]||"";

    const logs=data.playLogs.filter(l=>l[1]===uid);
    document.getElementById("m-plays").innerText = logs.length;
    const cnt={}; logs.forEach(l=>cnt[l[2]]=(cnt[l[2]]||0)+1);
    const s=Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const gl=document.getElementById("m-games"); gl.innerHTML="";
    s.forEach(x=>gl.innerHTML+=`<li>${x[0]} (${x[1]}å›)</li>`);

    const fbs=data.feedback.filter(f=>f[1]===uid);
    const fbDiv=document.getElementById("m-fb"); fbDiv.innerHTML="";
    fbs.reverse().slice(0,5).forEach(f=>fbDiv.innerHTML+=`<div style="border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:5px;">${f[7]} <span class="text-muted" style="font-size:0.7rem">${f[0].slice(5,10)}</span></div>`);

    openModal('uModal');
}

function saveU(){ post("adminUpdateUser",{userId:curU, banStatus:document.getElementById("m-ban").value, message:document.getElementById("m-msg").value, memo:document.getElementById("m-memo").value}); closeModal('uModal'); }
function bulk(a,c,i){ document.getElementById("b-ans").innerText=a; document.getElementById("b-cnt").innerText=c; bulkIds=i; openModal('bModal'); }
function execBulk(){ const m=document.getElementById("b-msg").value; if(m){ post("adminBulkMessage",{targetUserIds:bulkIds, message:m}); closeModal('bModal'); document.getElementById("b-msg").value=""; } }
function saveNotify(){ const a=document.getElementById("n-active").checked?"TRUE":"FALSE"; const t=document.getElementById("n-title").value; const x=document.getElementById("n-text").value.replaceAll("\n","<br>"); post("adminSaveConfigBatch",{data:{notificationActive:a, notificationTitle:t, notificationText:x}}); alert("ä¿å­˜ã—ã¾ã—ãŸ"); }
function pubSurvey(){ const q=document.getElementById("sv-q").value; const o=document.getElementById("sv-o").value; if(q&&confirm("å…¬é–‹ã—ã¾ã™ã‹ï¼Ÿ")){ post("adminSaveConfigBatch",{data:{surveyId:"survey_"+Date.now(), surveyQuestion:q, surveyOptions:o}}); alert("å…¬é–‹ã—ã¾ã—ãŸ"); } }
function addUp(){ const p={version:document.getElementById("up-v").value, date:document.getElementById("up-d").value, title:document.getElementById("up-t").value, details:document.getElementById("up-det").value, videoUrl:document.getElementById("up-vid").value}; if(p.version) post("adminAddUpdate",p); }
function addSc(){ const p={name:document.getElementById("sc-n").value, date:document.getElementById("sc-d").value}; if(p.name) post("adminAddSchedule",p); }
function del(s,i){ if(confirm("å‰Šé™¤ï¼Ÿ")) post("adminDeleteRow",{sheetName:s, rowIndex:i}); }
function switchTab(id,el){ document.querySelectorAll(".view-section").forEach(d=>d.classList.add("d-none")); document.getElementById("view-"+id).classList.remove("d-none"); document.querySelectorAll(".nav-link").forEach(l=>l.classList.remove("active")); const s=document.querySelector(`.sidebar .nav-link[onclick*='${id}']`); if(s)s.classList.add("active"); if(el){ document.querySelectorAll(".b-nav-item").forEach(x=>x.classList.remove("active")); el.classList.add("active"); } }
function logout(){ if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")){ localStorage.removeItem("admKey"); location.reload(); } }
</script>
</body>
</html>
