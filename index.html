<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Toway ç®¡ç†ãƒ‘ãƒãƒ«</title>

<style>
    :root {
        --bg-body: #f4f6f8;
        --bg-sidebar: #1e293b;
        --sidebar-width: 240px;
        --accent-color: #3b82f6;
        --text-main: #334155;
        --text-sub: #64748b;
        --border-color: #e2e8f0;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background-color: var(--bg-body); font-family: sans-serif; color: var(--text-main); font-size: 14px; }
    
    .d-none { display: none !important; }
    .w-100 { width: 100%; }
    .mb-3 { margin-bottom: 1rem; }
    .p-4 { padding: 1.5rem; }

    .app-container { display: flex; min-height: 100vh; }
    
    .sidebar {
        width: var(--sidebar-width); background: var(--bg-sidebar); color: #94a3b8;
        position: fixed; top: 0; bottom: 0; left: 0; padding: 1.5rem 1rem;
    }
    .sidebar-brand { font-size: 1.2rem; font-weight: bold; color: #fff; margin-bottom: 2rem; }
    .nav-link {
        display: block; color: inherit; padding: 0.8rem 1rem; border-radius: 8px; 
        text-decoration: none; margin-bottom: 4px; cursor: pointer;
    }
    .nav-link:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .nav-link.active { background: var(--accent-color); color: #fff; }

    .main-content { margin-left: var(--sidebar-width); flex: 1; padding: 2rem; }

    .card { background: #fff; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; }
    .card-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); font-weight: bold; }
    .card-body { padding: 1.5rem; }

    .form-control { width: 100%; padding: 0.7rem; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; }
    .btn { padding: 0.7rem 1.2rem; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
    .btn-primary { background: var(--accent-color); color: white; }
    .btn-danger { background: #ef4444; color: white; }

    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 10px; background: #f8fafc; border-bottom: 1px solid #eee; font-size: 0.8rem; }
    td { padding: 10px; border-bottom: 1px solid #f1f5f9; }

    .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; }
    .badge-online { background: #dcfce7; color: #166534; }
    .badge-ban { background: #fee2e2; color: #991b1b; }

    #login-screen { position: fixed; inset: 0; background: #f1f5f9; z-index: 10000; display: flex; justify-content: center; align-items: center; }
    .login-box { background: #fff; padding: 2rem; border-radius: 12px; width: 300px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
</style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h3 class="mb-3">Toway Admin</h3>
        <input type="password" id="loginPass" class="form-control" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
        <button class="btn btn-primary w-100" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <p id="loginMsg" style="color:red; margin-top:10px;"></p>
    </div>
</div>

<div class="app-container" id="app-main" style="display:none;">
    <div class="sidebar">
        <div class="sidebar-brand">Toway Admin</div>
        <a class="nav-link active" onclick="switchTab('notification', this)">ğŸ“¢ ãŠçŸ¥ã‚‰ã›è¨­å®š</a>
        <a class="nav-link" onclick="switchTab('users', this)">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
        <a class="nav-link" onclick="switchTab('feedback', this)">ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</a>
        <a class="nav-link" onclick="switchTab('updates', this)">ğŸ”„ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</a>
        <a class="nav-link" onclick="switchTab('schedule', this)">ğŸ“… äºˆå®šç®¡ç†</a>
        <button class="btn w-100" style="margin-top:20px; background:#475569; color:white;" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>

    <div class="main-content">
        <div id="view-notification" class="view-section">
            <h2 class="mb-3">ãŠçŸ¥ã‚‰ã›è¨­å®š</h2>
            <div class="card">
                <div class="card-body">
                    <label><input type="checkbox" id="n-active"> ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹</label>
                    <input type="text" id="n-title" class="form-control mt-3" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
                    <textarea id="n-text" rows="5" class="form-control" placeholder="æœ¬æ–‡..."></textarea>
                    <button class="btn btn-primary w-100" onclick="saveNotify()">è¨­å®šã‚’ä¿å­˜</button>
                </div>
            </div>
        </div>

        <div id="view-users" class="view-section d-none">
            <h2 class="mb-3">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
            <div class="card">
                <div class="card-body">
                    <table>
                        <thead><tr><th>ID</th><th>åˆå›ã‚¢ã‚¯ã‚»ã‚¹</th><th>æœ€çµ‚ã‚¢ã‚¯ã‚»ã‚¹</th><th>çŠ¶æ…‹</th><th>ãƒ¡ãƒ¢</th><th>æ“ä½œ</th></tr></thead>
                        <tbody id="u-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-feedback" class="view-section d-none">
            <h2 class="mb-3">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h2>
            <div class="card">
                <table>
                    <thead><tr><th>æ—¥æ™‚</th><th>åå‰</th><th>ç¨®é¡</th><th>å†…å®¹</th></tr></thead>
                    <tbody id="fb-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-updates" class="view-section d-none">
            <h2 class="mb-3">ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæƒ…å ±</h2>
            <div class="card p-4 mb-4">
                <input id="up-d" class="form-control" placeholder="æ—¥ä»˜ (2024/03/19)">
                <input id="up-t" class="form-control" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
                <textarea id="up-det" class="form-control" placeholder="å†…å®¹ (æ”¹è¡Œã§ç®‡æ¡æ›¸ã)"></textarea>
                <button class="btn btn-primary w-100" onclick="addUpdate()">è¿½åŠ </button>
            </div>
            <div class="card">
                <table id="up-table"></table>
            </div>
        </div>

        <div id="view-schedule" class="view-section d-none">
            <h2 class="mb-3">äºˆå®šç®¡ç†</h2>
            <div class="card p-4">
                <input id="sc-n" class="form-control" placeholder="é …ç›®å">
                <input id="sc-d" class="form-control" placeholder="æ—¥ä»˜">
                <button class="btn btn-primary w-100" onclick="addSchedule()">è¿½åŠ </button>
            </div>
            <div class="card mt-4">
                <table id="sc-table"></table>
            </div>
        </div>
    </div>
</div>

<script>
const API = "YOUR_GAS_URL_HERE"; // GASã®URLã‚’è²¼ã‚Šä»˜ã‘
let auth = "";
let data = null;

function login() {
    auth = document.getElementById("loginPass").value;
    fetchData();
}

function logout() {
    location.reload();
}

function switchTab(id, el) {
    document.querySelectorAll('.view-section').forEach(s => s.classList.add('d-none'));
    document.getElementById('view-' + id).classList.remove('d-none');
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    el.classList.add('active');
}

async function fetchData() {
    try {
        const r = await fetch(API, {
            method: "POST",
            body: JSON.stringify({ action: "adminGetData", payload: { password: auth } })
        });
        const j = await r.json();
        if (j.status === "success") {
            data = j.data;
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("app-main").style.display = "flex";
            render();
        } else {
            document.getElementById("loginMsg").innerText = "èªè¨¼å¤±æ•—";
        }
    } catch (e) { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); }
}

function render() {
    // ãŠçŸ¥ã‚‰ã›åŒæœŸ
    document.getElementById("n-active").checked = (data.config.notificationActive === "TRUE");
    document.getElementById("n-title").value = data.config.notificationTitle || "";
    document.getElementById("n-text").value = (data.config.notificationText || "").replace(/<br>/g, "\n");

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼
    const ut = document.getElementById("u-tbody"); ut.innerHTML = "";
    data.users.reverse().forEach((u, i) => {
        ut.innerHTML += `<tr>
            <td>${u[0]}</td>
            <td>${u[1]}</td>
            <td>${u[2]}</td>
            <td>${u[3] === 'TRUE' ? '<span class="badge badge-ban">BAN</span>' : 'æ­£å¸¸'}</td>
            <td>${u[5] || ''}</td>
            <td><button class="btn" style="background:#eee" onclick="promptBan('${u[0]}')">å¤‰æ›´</button></td>
        </tr>`;
    });

    // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    const fb = document.getElementById("fb-body"); fb.innerHTML = "";
    data.feedback.reverse().forEach(f => {
        fb.innerHTML += `<tr><td>${f[0]}</td><td>${f[2]}</td><td>${f[3]}</td><td>${f[5]}</td></tr>`;
    });

    // ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
    const upt = document.getElementById("up-table"); upt.innerHTML = "";
    data.updates.reverse().forEach((u, i) => {
        upt.innerHTML += `<tr><td>${u[0]}</td><td>${u[1]}</td><td><button class="btn btn-danger" onclick="del('Updates', ${i})">å‰Šé™¤</button></td></tr>`;
    });

    // äºˆå®š
    const sct = document.getElementById("sc-table"); sct.innerHTML = "";
    data.schedule.reverse().forEach((s, i) => {
        sct.innerHTML += `<tr><td>${s[0]}</td><td>${s[1]}</td><td><button class="btn btn-danger" onclick="del('Schedule', ${i})">å‰Šé™¤</button></td></tr>`;
    });
}

async function saveNotify() {
    const payload = {
        notificationActive: document.getElementById("n-active").checked ? "TRUE" : "FALSE",
        notificationTitle: document.getElementById("n-title").value,
        notificationText: document.getElementById("n-text").value.replace(/\n/g, "<br>")
    };
    await callApi("adminSaveConfigBatch", { data: payload });
}

async function addUpdate() {
    const payload = {
        date: document.getElementById("up-d").value,
        title: document.getElementById("up-t").value,
        details: document.getElementById("up-det").value
    };
    await callApi("adminAddUpdate", payload);
}

async function addSchedule() {
    const payload = {
        name: document.getElementById("sc-n").value,
        date: document.getElementById("sc-d").value
    };
    await callApi("adminAddSchedule", payload);
}

async function promptBan(uid) {
    const msg = prompt("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    const ban = confirm("BANã«ã—ã¾ã™ã‹ï¼Ÿ");
    await callApi("adminUpdateUser", { userId: uid, message: msg, banStatus: ban });
}

async function del(sheet, idx) {
    if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        await callApi("adminDeleteRow", { sheetName: sheet, rowIndex: idx });
    }
}

async function callApi(action, payload) {
    payload.password = auth;
    const r = await fetch(API, { method: "POST", body: JSON.stringify({ action, payload }) });
    const j = await r.json();
    if (j.status === "success") fetchData();
}
</script>
</body>
</html>
