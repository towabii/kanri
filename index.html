<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Admin Dashboard v3</title>

<style>
    /* --- Modern Design System --- */
    :root {
        --primary: #4f46e5; /* Indigo */
        --primary-light: #e0e7ff;
        --bg-body: #f3f4f6;
        --bg-card: #ffffff;
        --text-main: #1f2937;
        --text-sub: #6b7280;
        --danger: #ef4444;
        --success: #10b981;
        --border: #e5e7eb;
        --radius: 16px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { background-color: var(--bg-body); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; color: var(--text-main); font-size: 15px; line-height: 1.5; padding-bottom: 80px; }

    /* --- Utilities --- */
    .d-none { display: none !important; }
    .d-flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-2 { gap: 0.5rem; }
    .gap-4 { gap: 1rem; }
    .w-full { width: 100%; }
    .font-bold { font-weight: 700; }
    .text-sm { font-size: 0.85rem; }
    .text-xs { font-size: 0.75rem; }
    .text-muted { color: var(--text-sub); }
    .text-primary { color: var(--primary); }
    .text-danger { color: var(--danger); }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .mt-4 { margin-top: 1rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .p-4 { padding: 1rem; }

    /* --- Layout --- */
    .app-layout { display: flex; min-height: 100vh; }
    
    /* Sidebar (PC) */
    .sidebar {
        width: 260px; background: #111827; color: #9ca3af;
        position: fixed; inset: 0 auto 0 0; z-index: 50;
        display: none; flex-direction: column; padding: 1.5rem;
    }
    .brand { font-size: 1.4rem; font-weight: 800; color: #fff; margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; }
    .nav-group { margin-bottom: 1.5rem; }
    .nav-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; margin-bottom: 0.5rem; color: #4b5563; }
    .nav-item {
        display: block; padding: 0.75rem 1rem; border-radius: 12px; cursor: pointer;
        transition: 0.2s; margin-bottom: 4px; font-weight: 500;
    }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .nav-item.active { background: var(--primary); color: #fff; }

    /* Main Content */
    .main { flex: 1; padding: 1.5rem; width: 100%; max-width: 1200px; margin: 0 auto; }
    
    @media (min-width: 1024px) {
        .sidebar { display: flex; }
        .main { margin-left: 260px; padding: 2rem; }
        .bottom-nav { display: none !important; }
    }

    /* --- Cards --- */
    .card {
        background: var(--bg-card); border-radius: var(--radius);
        box-shadow: var(--shadow); overflow: hidden; margin-bottom: 1.5rem;
        border: 1px solid var(--border);
    }
    .card-header {
        padding: 1rem 1.25rem; border-bottom: 1px solid var(--border);
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(255,255,255,0.5); backdrop-filter: blur(8px);
    }
    .card-title { font-weight: 700; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
    .card-body { padding: 1.25rem; }

    /* --- Stats Grid --- */
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    @media(min-width: 768px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }
    
    .stat-box {
        background: #fff; padding: 1rem; border-radius: var(--radius);
        border: 1px solid var(--border); box-shadow: var(--shadow);
        display: flex; flex-direction: column; justify-content: center;
    }
    .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--text-main); line-height: 1.2; }
    .stat-lbl { font-size: 0.75rem; font-weight: 600; color: var(--text-sub); text-transform: uppercase; }

    /* --- Forms & Inputs --- */
    .form-label { display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem; }
    .input {
        width: 100%; padding: 0.8rem; border-radius: 10px; border: 1px solid #d1d5db;
        font-size: 16px; /* iOS zoom prevent */ transition: 0.2s; background: #f9fafb;
    }
    .input:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px var(--primary-light); }
    textarea.input { min-height: 100px; resize: vertical; }

    /* --- Buttons --- */
    .btn {
        display: inline-flex; align-items: center; justify-content: center;
        padding: 0.8rem 1.2rem; border-radius: 10px; border: none; font-weight: 600;
        cursor: pointer; transition: 0.2s; font-size: 0.95rem;
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-dark { background: #1f2937; color: #fff; }
    .btn-ghost { background: transparent; color: var(--text-sub); border: 1px solid var(--border); }
    .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
    .btn-group { display: flex; gap: 0.5rem; background: #f3f4f6; padding: 4px; border-radius: 10px; }
    .btn-tab { flex: 1; background: transparent; border: none; padding: 6px; font-size: 0.8rem; color: #6b7280; border-radius: 8px; }
    .btn-tab.active { background: #fff; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-weight: 700; }

    /* --- Toggle Switch --- */
    .toggle-wrapper { display: flex; align-items: center; cursor: pointer; justify-content: space-between; width: 100%; padding: 0.5rem 0; }
    .toggle-track { width: 50px; height: 28px; background: #d1d5db; border-radius: 20px; position: relative; transition: 0.3s; }
    .toggle-dot { width: 22px; height: 22px; background: #fff; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    input:checked + .toggle-track { background: var(--success); }
    input:checked + .toggle-track .toggle-dot { transform: translateX(22px); }

    /* --- Tables --- */
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; white-space: nowrap; }
    th { text-align: left; padding: 1rem; background: #f9fafb; font-size: 0.8rem; color: var(--text-sub); border-bottom: 1px solid var(--border); }
    td { padding: 1rem; border-bottom: 1px solid #f3f4f6; }
    tr:last-child td { border-bottom: none; }
    
    /* --- Badges --- */
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
    .badge-ok { background: #d1fae5; color: #065f46; }
    .badge-ng { background: #fee2e2; color: #991b1b; }
    .badge-neutral { background: #f3f4f6; color: #374151; }

    /* --- Bottom Nav (Mobile) --- */
    .bottom-nav {
        position: fixed; bottom: 0; left: 0; right: 0; height: 65px; background: #fff;
        border-top: 1px solid var(--border); display: flex; justify-content: space-around;
        padding-bottom: safe-area-inset-bottom; z-index: 100;
    }
    .b-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #9ca3af; font-size: 0.7rem; }
    .b-item.active { color: var(--primary); }
    .b-icon { font-size: 1.4rem; margin-bottom: 2px; }

    /* --- Modal --- */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200;
        display: none; justify-content: center; align-items: flex-end; backdrop-filter: blur(2px);
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
        background: #fff; width: 100%; max-width: 600px; height: 90vh;
        border-radius: 24px 24px 0 0; padding: 1.5rem; overflow-y: auto;
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex; flex-direction: column;
    }
    @media(min-width: 600px) {
        .modal-overlay { align-items: center; }
        .modal-content { height: auto; max-height: 85vh; border-radius: 16px; width: 90%; }
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* --- Chart & Timeline --- */
    canvas { width: 100% !important; height: 200px !important; }
    .timeline-item { padding-left: 1.5rem; border-left: 2px solid #e5e7eb; position: relative; padding-bottom: 1.5rem; margin-left: 0.5rem; }
    .timeline-item::before { content:''; position: absolute; left: -7px; top: 0; width: 12px; height: 12px; background: #fff; border: 3px solid var(--primary); border-radius: 50%; }

    /* --- Login --- */
    #login-wrap { position: fixed; inset: 0; background: #f3f4f6; z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 1rem; }
    .login-box { background: #fff; padding: 2rem; border-radius: 16px; width: 100%; max-width: 360px; box-shadow: var(--shadow); text-align: center; }
</style>
</head>
<body>

<!-- Login -->
<div id="login-wrap">
    <div class="login-box">
        <div style="font-size:3rem; margin-bottom:0.5rem;">ğŸ”</div>
        <h2 class="font-bold mb-2">Admin Panel</h2>
        <p class="text-muted text-sm mb-4">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="password" id="pass" class="input mb-4" style="text-align:center;" placeholder="Password">
        <button class="btn btn-primary w-full" onclick="tryLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div id="login-msg" class="text-danger text-sm mt-4 font-bold"></div>
    </div>
</div>

<!-- App Layout -->
<div id="app" class="app-layout d-none">
    
    <!-- PC Sidebar -->
    <nav class="sidebar">
        <div class="brand">ğŸ“Š Admin v3</div>
        <div class="nav-group">
            <div class="nav-label">Main</div>
            <a class="nav-item active" onclick="nav('dash')">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            <a class="nav-item" onclick="nav('users')">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
            <a class="nav-item" onclick="nav('feed')">ğŸ’¬ å—ä¿¡ãƒˆãƒ¬ã‚¤</a>
        </div>
        <div class="nav-group">
            <div class="nav-label">Settings</div>
            <a class="nav-item" onclick="nav('notif')">ğŸ“¢ ãŠçŸ¥ã‚‰ã›è¨­å®š</a>
            <a class="nav-item" onclick="nav('survey')">ğŸ“ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</a>
        </div>
        <div class="nav-group">
            <div class="nav-label">Content</div>
            <a class="nav-item" onclick="nav('upd')">ğŸ”„ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</a>
            <a class="nav-item" onclick="nav('sch')">ğŸ“… äºˆå®šè¡¨</a>
        </div>
        <div style="margin-top:auto">
            <button class="btn btn-ghost w-full" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        
        <!-- DASHBOARD -->
        <div id="view-dash" class="view">
            <div class="d-flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                <div class="text-xs text-muted" id="last-sync">Syncing...</div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-lbl">Online</div>
                    <div class="stat-val text-primary" id="s-online">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-lbl">Users</div>
                    <div class="stat-val" id="s-total">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-lbl">Feedback</div>
                    <div class="stat-val" id="s-feed">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-lbl">Answers</div>
                    <div class="stat-val" id="s-ans">-</div>
                </div>
            </div>

            <div class="d-flex flex-col gap-4" style="flex-direction: column-reverse; md:flex-row;">
                <!-- Chart -->
                <div class="card w-full">
                    <div class="card-header"><span class="card-title">ğŸ“ˆ æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ (6ãƒ¶æœˆ)</span></div>
                    <div class="card-body">
                        <canvas id="chart"></canvas>
                    </div>
                </div>

                <!-- Ranking -->
                <div class="card w-full">
                    <div class="card-header">
                        <span class="card-title">ğŸ† äººæ°—ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
                    </div>
                    <div class="p-4 bg-white" style="border-bottom:1px solid var(--border);">
                        <!-- Ranking Tabs -->
                        <div class="btn-group">
                            <button class="btn-tab active" onclick="setRankMode('month', this)">ä»Šæœˆ</button>
                            <button class="btn-tab" onclick="setRankMode('half', this)">ç›´è¿‘6ãƒ¶æœˆ</button>
                            <button class="btn-tab" onclick="setRankMode('all', this)">ç·åˆ</button>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table class="table">
                            <tbody id="rank-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">âš¡ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</span></div>
                <div class="card-body" id="timeline"></div>
            </div>
        </div>

        <!-- NOTIFICATION -->
        <div id="view-notif" class="view d-none">
            <h2 class="font-bold text-lg mb-4">ãŠçŸ¥ã‚‰ã›è¨­å®š</h2>
            <div class="card" style="max-width: 600px; margin:0 auto;">
                <div class="card-body">
                    <!-- Toggle Switch -->
                    <label class="toggle-wrapper mb-4">
                        <div>
                            <div class="font-bold">ãŠçŸ¥ã‚‰ã›æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–</div>
                            <div class="text-xs text-muted">ONã«ã™ã‚‹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨ªå•æ™‚ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
                        </div>
                        <div style="position:relative;">
                            <input type="checkbox" id="n-active" class="d-none">
                            <div class="toggle-track"><div class="toggle-dot"></div></div>
                        </div>
                    </label>
                    <hr class="mb-4" style="border:none; border-top:1px solid #eee;">
                    
                    <div class="mb-4">
                        <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input id="n-title" class="input" placeholder="ä¾‹: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›">
                    </div>
                    <div class="mb-4">
                        <label class="form-label">æœ¬æ–‡ (<span class="text-danger">#æ–‡å­—#</span>ã§èµ¤è‰²å¼·èª¿)</label>
                        <textarea id="n-text" class="input" placeholder="æœ¬æ–‡ã‚’å…¥åŠ›..."></textarea>
                    </div>
                    <button class="btn btn-primary w-full" onclick="saveNotif()">è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹</button>
                </div>
            </div>
        </div>

        <!-- SURVEY -->
        <div id="view-survey" class="view d-none">
            <h2 class="font-bold text-lg mb-4">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç®¡ç†</h2>
            
            <div class="btn-group mb-4" style="max-width:400px;">
                <button class="btn-tab active" onclick="switchSurveyView('current', this)">ç¾åœ¨ã®è¨­å®š</button>
                <button class="btn-tab" onclick="switchSurveyView('history', this)">éå»ã®é›†è¨ˆå±¥æ­´</button>
            </div>

            <!-- Current Survey -->
            <div id="sv-current">
                <div class="d-flex flex-col gap-4">
                    <div class="card">
                        <div class="card-header font-bold">æ–°è¦ä½œæˆ / æ›´æ–°</div>
                        <div class="card-body">
                            <div class="text-xs text-danger mb-2 p-2" style="background:#fee2e2; border-radius:8px;">âš ï¸ å…¬é–‹ã™ã‚‹ã¨ç¾åœ¨ã®é›†è¨ˆã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</div>
                            <label class="form-label">è³ªå•æ–‡</label>
                            <input id="sv-q" class="input mb-3" placeholder="è³ªå•...">
                            <label class="form-label">é¸æŠè‚¢ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                            <input id="sv-o" class="input mb-4" placeholder="ä¾‹: A,B,C">
                            <button class="btn btn-primary w-full" onclick="pubSurvey()">å…¬é–‹ã™ã‚‹</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header font-bold">ç¾åœ¨ã®é›†è¨ˆçµæœ</div>
                        <div class="card-body">
                            <div class="mb-2"><span class="badge badge-neutral">è³ªå•</span> <span id="sv-cur-q" class="font-bold">-</span></div>
                            <hr class="mb-4" style="border:0; border-top:1px solid #eee;">
                            <div id="sv-res-area"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Survey History -->
            <div id="sv-history" class="d-none">
                <div id="sv-hist-list" class="d-flex flex-col gap-4"></div>
            </div>
        </div>

        <!-- USERS -->
        <div id="view-users" class="view d-none">
            <h2 class="font-bold text-lg mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
            <div class="card mb-4">
                <div class="card-body p-2">
                    <input id="u-search" class="input" placeholder="ğŸ” åå‰ã€IDã€ãƒ¡ãƒ¢ã§æ¤œç´¢..." onkeyup="filterUsers()">
                </div>
            </div>
            <div class="card">
                <div class="table-wrap">
                    <table class="table">
                        <thead><tr><th>Status</th><th>Name / ID</th><th>Last Login</th><th>Memo</th><th>Action</th></tr></thead>
                        <tbody id="u-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- OTHERS (Simplified) -->
        <div id="view-feed" class="view d-none">
            <h2 class="font-bold text-lg mb-4">å—ä¿¡ãƒˆãƒ¬ã‚¤</h2>
            <div class="card"><div class="table-wrap"><table class="table"><tbody id="feed-list"></tbody></table></div></div>
        </div>
        <div id="view-upd" class="view d-none">
            <h2 class="font-bold text-lg mb-4">ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç®¡ç†</h2>
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex gap-2 mb-2">
                        <input id="up-v" class="input" placeholder="Ver (v1.0)" style="flex:1">
                        <input id="up-d" class="input" placeholder="æ—¥ä»˜" style="flex:1">
                    </div>
                    <input id="up-t" class="input mb-2" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
                    <input id="up-vid" class="input mb-2" placeholder="å‹•ç”»URL">
                    <textarea id="up-det" class="input mb-2" placeholder="è©³ç´°"></textarea>
                    <button class="btn btn-dark w-full" onclick="addUp()">è¿½åŠ </button>
                </div>
            </div>
            <div class="card"><div class="table-wrap"><table class="table"><tbody id="up-list"></tbody></table></div></div>
        </div>
        <div id="view-sch" class="view d-none">
             <h2 class="font-bold text-lg mb-4">äºˆå®šç®¡ç†</h2>
             <div class="card mb-4">
                <div class="card-body">
                    <input id="sc-n" class="input mb-2" placeholder="äºˆå®šå">
                    <input id="sc-d" class="input mb-2" placeholder="æ—¥æ™‚">
                    <button class="btn btn-dark w-full" onclick="addSch()">è¿½åŠ </button>
                </div>
            </div>
            <div class="card"><div class="table-wrap"><table class="table"><tbody id="sch-list"></tbody></table></div></div>
        </div>

    </main>

    <!-- Mobile Bottom Nav -->
    <nav class="bottom-nav">
        <div class="b-item active" onclick="nav('dash',this)"><span class="b-icon">ğŸ </span><span>Home</span></div>
        <div class="b-item" onclick="nav('users',this)"><span class="b-icon">ğŸ‘¥</span><span>Users</span></div>
        <div class="b-item" onclick="nav('notif',this)"><span class="b-icon">ğŸ“¢</span><span>Info</span></div>
        <div class="b-item" onclick="nav('survey',this)"><span class="b-icon">ğŸ“</span><span>Poll</span></div>
    </nav>

</div>

<!-- USER MODAL -->
<div class="modal-overlay" id="uModal">
    <div class="modal-content">
        <div class="d-flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°</h3>
            <button onclick="closeModal('uModal')" class="btn btn-ghost" style="font-size:1.5rem; padding:0 10px;">Ã—</button>
        </div>
        <div class="d-flex items-center gap-4 mb-4">
            <div id="m-av" style="width:60px; height:60px; background:var(--primary); color:#fff; border-radius:50%; display:flex; items-center; justify-center; font-size:1.5rem; font-weight:bold; display:flex; align-items:center; justify-content:center;">U</div>
            <div style="flex:1; overflow:hidden;">
                <div id="m-name" class="font-bold text-lg">Name</div>
                <div id="m-id" class="text-xs text-muted">ID</div>
            </div>
            <div id="m-badge"></div>
        </div>
        
        <div class="d-flex gap-2 mb-4 text-center bg-gray-50 p-2 rounded" style="background:#f9fafb; border-radius:12px;">
            <div class="w-full">
                <div class="text-xs text-muted">åˆå›</div>
                <div id="m-reg" class="font-bold text-sm">-</div>
            </div>
            <div class="w-full">
                <div class="text-xs text-muted">ãƒ—ãƒ¬ã‚¤æ•°</div>
                <div id="m-play" class="font-bold text-sm">0</div>
            </div>
        </div>

        <div class="mb-4">
            <label class="form-label">ç®¡ç†è€…ãƒ¡ãƒ¢</label>
            <input id="m-memo" class="input" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›...">
        </div>
        
        <div class="mb-4">
            <label class="form-label">ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ (BAN)</label>
            <div class="btn-group">
                <button class="btn-tab active" id="btn-ban-false" onclick="setBanUI(false)">è¨±å¯ (é€šå¸¸)</button>
                <button class="btn-tab" id="btn-ban-true" onclick="setBanUI(true)">ç¦æ­¢ (BAN)</button>
            </div>
            <input type="hidden" id="m-ban-val">
        </div>

        <div class="mb-4">
            <label class="form-label">å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
            <input id="m-msg" class="input" placeholder="æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«è¡¨ç¤ºã•ã‚Œã¾ã™">
        </div>
        
        <button class="btn btn-primary w-full mb-4" onclick="saveUser()">ä¿å­˜ã™ã‚‹</button>

        <hr class="mb-4" style="border:0; border-top:1px solid #eee;">
        <h4 class="font-bold text-sm mb-2">ãƒ—ãƒ¬ã‚¤å±¥æ­´ (Top 5)</h4>
        <ul id="m-hist" class="text-sm text-muted" style="padding-left:1.2rem;"></ul>
    </div>
</div>

<script>
/* --- LOGIC --- */
const API = "https://script.google.com/macros/s/AKfycbzJSO_Bq80Qc1UI8RNyKBJ2Az81QfFkqdO-0j9nLglrEkirg-69sxYfPdGMbq9l30AO/exec";
let auth="", data=null, timer=null;
let rankMode = "month"; // month, half, all
let curUser = null;

const dom = (id) => document.getElementById(id);
const hide = (id) => dom(id).classList.add("d-none");
const show = (id) => dom(id).classList.remove("d-none");

/* Init */
window.onload = () => {
    const key = localStorage.getItem("admKey");
    if(key) { dom("pass").value = key; tryLogin(); }
};

async function tryLogin() {
    const p = dom("pass").value;
    if(!p) return;
    dom("login-msg").innerText = "èªè¨¼ä¸­...";
    try {
        const r = await fetch(API, { method:"POST", body:JSON.stringify({ action:"adminGetData", payload:{ password:p } }) });
        const j = await r.json();
        if(j.status === "success") {
            auth = p; data = j.data;
            localStorage.setItem("admKey", p);
            hide("login-wrap"); show("app");
            renderAll();
            timer = setInterval(fetchData, 15000);
        } else {
            dom("login-msg").innerText = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
            localStorage.removeItem("admKey");
        }
    } catch(e) { dom("login-msg").innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼"; }
}

async function fetchData() {
    if(document.querySelector(".modal-overlay.active")) return; // ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸­ã¯æ›´æ–°ã—ãªã„
    try {
        const r = await fetch(API, { method:"POST", body:JSON.stringify({ action:"adminGetData", payload:{ password:auth } }) });
        const j = await r.json();
        if(j.status==="success") { data = j.data; renderAll(); }
    } catch(e){}
}

/* Rendering Main */
function renderAll() {
    if(!data) return;
    const now = new Date();
    
    // Stats
    const threshold = 10 * 60 * 1000; // 10 min
    const online = data.users.filter(u => u[2] && (now - new Date(u[2]).getTime() < threshold)).length;
    dom("s-online").innerText = online;
    dom("s-total").innerText = data.users.length;
    dom("s-feed").innerText = data.feedback.length;
    dom("s-ans").innerText = data.surveyResponses.length;
    dom("last-sync").innerText = now.getHours()+":"+String(now.getMinutes()).padStart(2,"0")+" æ›´æ–°";

    // Chart
    drawChart();

    // Ranking (Refresh based on current mode)
    renderRank();

    // Timeline
    let feed = [];
    data.users.forEach(u => feed.push({t:new Date(u[1]), txt:`New User: ${u[0].slice(0,5)}...`}));
    data.feedback.forEach(f => feed.push({t:new Date(f[0]), txt:`Feedback: ${f[3]}`}));
    feed.sort((a,b)=>b.t-a.t);
    dom("timeline").innerHTML = feed.slice(0,8).map(x=>
        `<div class="timeline-item"><div class="text-xs text-muted">${x.t.getMonth()+1}/${x.t.getDate()} ${x.t.getHours()}:${String(x.t.getMinutes()).padStart(2,"0")}</div><div class="text-sm">${x.txt}</div></div>`
    ).join("");

    // Notification Form
    // ç¢ºå®Ÿã«æ–‡å­—åˆ—ã¨ã—ã¦æ¯”è¼ƒ
    const nActive = String(data.config.notificationActive).toUpperCase() === "TRUE";
    dom("n-active").checked = nActive;
    dom("n-title").value = data.config.notificationTitle || "";
    dom("n-text").value = (data.config.notificationText || "").replaceAll("<br>","\n");

    // Survey
    const q = data.config.surveyQuestion || "(æœªè¨­å®š)";
    dom("sv-cur-q").innerText = q;
    renderSurveyRes(q, "sv-res-area");
    renderSurveyHistory();

    // Users
    renderUsers();

    // Others
    renderList("feed-list", data.feedback, r => `<td>${r[0].slice(5,16)}</td><td><div class="font-bold">${r[2]}</div><div class="text-xs text-muted">${r[1]}</div></td><td>${r[3]}</td><td style="white-space:normal">${r[7]}</td>`);
    renderList("up-list", data.updates, (r,i) => `<td>${r[0]}</td><td>${r[1]}</td><td style="white-space:normal">${r[2]}</td><td><button class="btn btn-sm text-danger" onclick="del('Updates',${i})">Ã—</button></td>`);
    renderList("sch-list", data.schedule, (r,i) => `<td>${r[0]}</td><td>${r[1]}</td><td><button class="btn btn-sm text-danger" onclick="del('Schedule',${i})">Ã—</button></td>`);
}

/* Rank Logic */
function setRankMode(m, el) {
    rankMode = m;
    el.parentNode.querySelectorAll(".btn-tab").forEach(b=>b.classList.remove("active"));
    el.classList.add("active");
    renderRank();
}

function renderRank() {
    const now = new Date();
    let limitDate = new Date(0); // All time

    if(rankMode === 'month') limitDate = new Date(now.getFullYear(), now.getMonth(), 1);
    else if(rankMode === 'half') limitDate = new Date(now.getFullYear(), now.getMonth()-6, 1);

    const counts = {};
    data.playLogs.forEach(l => {
        const d = new Date(l[0].replace(/-/g,'/'));
        if(d >= limitDate) counts[l[2]] = (counts[l[2]]||0)+1;
    });

    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const html = sorted.length ? sorted.map((x,i)=>
        `<tr><td class="font-bold">${i+1}</td><td>${x[0]}</td><td class="text-right font-bold">${x[1]}</td></tr>`
    ).join("") : `<tr><td colspan="3" class="text-center text-muted p-4">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>`;
    
    dom("rank-body").innerHTML = html;
}

/* Survey Logic */
function renderSurveyRes(quest, targetId) {
    const box = dom(targetId); box.innerHTML = "";
    if(!quest || quest==="(æœªè¨­å®š)") { box.innerHTML="<div class='text-center text-muted'>ãƒ‡ãƒ¼ã‚¿ãªã—</div>"; return; }
    
    const cnt = {}; let total = 0;
    data.surveyResponses.forEach(r => {
        if(r[3] === quest) { cnt[r[4]] = (cnt[r[4]]||0)+1; total++; }
    });

    if(total===0) { box.innerHTML="<div class='text-center text-muted'>å›ç­”ãªã—</div>"; return; }

    Object.keys(cnt).forEach(ans => {
        const pct = Math.round(cnt[ans]/total*100);
        box.innerHTML += `
            <div class="mb-2">
                <div class="d-flex justify-between text-sm mb-1"><span>${ans}</span><span>${cnt[ans]} (${pct}%)</span></div>
                <div style="background:#f3f4f6; height:8px; border-radius:4px; overflow:hidden;">
                    <div style="background:var(--primary); width:${pct}%; height:100%;"></div>
                </div>
            </div>`;
    });
}

function renderSurveyHistory() {
    // Group by question
    const qs = {};
    data.surveyResponses.forEach(r => {
        const q = r[3];
        if(!qs[q]) qs[q] = { last: r[0], count: 0 };
        qs[q].count++;
        if(new Date(r[0]) > new Date(qs[q].last)) qs[q].last = r[0];
    });

    const list = Object.entries(qs).sort((a,b)=> new Date(b[1].last) - new Date(a[1].last));
    
    const container = dom("sv-hist-list"); container.innerHTML = "";
    list.forEach(([qText, info]) => {
        const uid = "sv-h-"+Math.random().toString(36).substr(2,9);
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
            <div class="card-header" style="cursor:pointer;" onclick="document.getElementById('${uid}').classList.toggle('d-none')">
                <div>
                    <div class="font-bold text-sm">${qText}</div>
                    <div class="text-xs text-muted">Last: ${info.last.slice(0,10)} / Total: ${info.count}</div>
                </div>
                <div>â–¼</div>
            </div>
            <div class="card-body d-none" id="${uid}"></div>
        `;
        container.appendChild(div);
        renderSurveyRes(qText, uid); // Render bars inside
    });
}

function switchSurveyView(mode, btn) {
    if(mode==='current'){ show('sv-current'); hide('sv-history'); }
    else { hide('sv-current'); show('sv-history'); }
    btn.parentNode.querySelectorAll(".btn-tab").forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
}

/* User Management */
function renderUsers() {
    const list = dom("u-list"); list.innerHTML = "";
    const nameMap = {}; data.feedback.forEach(f=>nameMap[f[1]]=f[2]);

    [...data.users].reverse().forEach(u => {
        const [uid, reg, acc, ban, msg, memo] = u;
        const name = nameMap[uid] || "No Name";
        const isBan = String(ban).toUpperCase() === "TRUE";
        const isOnline = acc && (new Date() - new Date(acc) < 10*60*1000);
        
        const badge = isBan ? `<span class="badge badge-ng">BAN</span>` : (isOnline ? `<span class="badge badge-ok">Online</span>` : `<span class="badge badge-neutral">Offline</span>`);
        
        const tr = document.createElement("tr");
        tr.className = "u-row";
        tr.dataset.s = (uid+name+(memo||"")).toLowerCase();
        tr.innerHTML = `
            <td>${badge}</td>
            <td><div class="font-bold">${name}</div><div class="text-xs text-muted">${uid}</div></td>
            <td>${acc ? acc.slice(5,16) : '-'}</td>
            <td style="max-width:100px; overflow:hidden; text-overflow:ellipsis;">${memo||""}</td>
            <td><button class="btn btn-sm btn-ghost" onclick="openUser('${uid}')">è©³ç´°</button></td>
        `;
        list.appendChild(tr);
    });
    filterUsers();
}

function filterUsers() {
    const k = dom("u-search").value.toLowerCase();
    document.querySelectorAll(".u-row").forEach(r => {
        r.style.display = r.dataset.s.includes(k) ? "" : "none";
    });
}

function openUser(uid) {
    const u = data.users.find(x=>x[0]===uid);
    curUser = u;
    const name = data.feedback.find(f=>f[1]===uid)?.[2] || "No Name";
    
    dom("m-name").innerText = name;
    dom("m-id").innerText = uid;
    dom("m-av").innerText = name.charAt(0);
    dom("m-reg").innerText = u[1] ? u[1].slice(0,10) : "-";
    dom("m-memo").value = u[5] || "";
    dom("m-msg").value = u[4] || "";
    
    // BAN UI
    const isBan = String(u[3]).toUpperCase() === "TRUE";
    setBanUI(isBan);
    dom("m-badge").innerHTML = isBan ? `<span class="badge badge-ng">åœæ­¢ä¸­</span>` : `<span class="badge badge-ok">æœ‰åŠ¹</span>`;

    // History
    const logs = data.playLogs.filter(l=>l[1]===uid);
    dom("m-play").innerText = logs.length;
    const cnt = {}; logs.forEach(l=>cnt[l[2]]=(cnt[l[2]]||0)+1);
    const sorted = Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,5);
    dom("m-hist").innerHTML = sorted.length ? sorted.map(x=>`<li>${x[0]} (${x[1]})</li>`).join("") : "<li>å±¥æ­´ãªã—</li>";

    dom("uModal").classList.add("active");
}

function setBanUI(isBan) {
    dom("m-ban-val").value = isBan ? "TRUE" : "FALSE";
    if(isBan) {
        dom("btn-ban-true").classList.add("active");
        dom("btn-ban-false").classList.remove("active");
    } else {
        dom("btn-ban-true").classList.remove("active");
        dom("btn-ban-false").classList.add("active");
    }
}

/* Actions */
async function post(act, py) {
    py.password = auth;
    const btn = document.querySelector("button:active") || document.body;
    const oldText = btn.innerText;
    if(btn.tagName==="BUTTON") btn.innerText = "...";
    
    try {
        await fetch(API, { method:"POST", body:JSON.stringify({ action:act, payload:py }) });
        await fetchData();
        alert("å®Œäº†ã—ã¾ã—ãŸ");
    } catch(e) { alert("ã‚¨ãƒ©ãƒ¼"); }
    
    if(btn.tagName==="BUTTON") btn.innerText = oldText;
}

function saveNotif() {
    const active = dom("n-active").checked ? "TRUE" : "FALSE";
    const title = dom("n-title").value;
    const text = dom("n-text").value.replaceAll("\n", "<br>");
    post("adminSaveConfigBatch", { data: { notificationActive: active, notificationTitle: title, notificationText: text } });
}

function saveUser() {
    post("adminUpdateUser", { 
        userId: curUser[0], 
        banStatus: dom("m-ban-val").value, 
        message: dom("m-msg").value, 
        memo: dom("m-memo").value 
    });
    closeModal('uModal');
}

function pubSurvey() {
    const q = dom("sv-q").value;
    const o = dom("sv-o").value;
    if(q && confirm("å…¬é–‹ã—ã¾ã™ã‹ï¼Ÿ")) {
        post("adminSaveConfigBatch", { data: { surveyId: "S"+Date.now(), surveyQuestion: q, surveyOptions: o } });
    }
}

function addUp() {
    const p = { version: dom("up-v").value, date: dom("up-d").value, title: dom("up-t").value, details: dom("up-det").value, videoUrl: dom("up-vid").value };
    if(p.version) post("adminAddUpdate", p);
}
function addSch() { post("adminAddSchedule", { name: dom("sc-n").value, date: dom("sc-d").value }); }
function del(s,i) { if(confirm("å‰Šé™¤?")) post("adminDeleteRow", { sheetName:s, rowIndex:i }); }

/* Helper */
function renderList(id, arr, fn) { dom(id).innerHTML = arr.map((r,i) => `<tr>${fn(r,i)}</tr>`).join(""); }
function nav(id, el) {
    document.querySelectorAll(".view").forEach(v=>v.classList.add("d-none"));
    show("view-"+id);
    document.querySelectorAll(".nav-item, .b-item").forEach(x=>x.classList.remove("active"));
    if(el) el.classList.add("active"); // Mobile
    // Desktop Sync
    const dLink = document.querySelector(`.nav-item[onclick*="${id}"]`);
    if(dLink) dLink.classList.add("active");
}
function closeModal(id) { dom(id).classList.remove("active"); }
function logout() { localStorage.removeItem("admKey"); location.reload(); }

/* Simple Chart */
function drawChart() {
    const cvs = dom("chart");
    const ctx = cvs.getContext("2d");
    cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight;
    const w = cvs.width, h = cvs.height;
    
    // Last 6 months
    const labs = [], vals = [];
    for(let i=5; i>=0; i--) {
        const d = new Date(); d.setMonth(d.getMonth()-i);
        const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        labs.push(k);
        vals.push(data.users.filter(u=> u[1] && u[1].startsWith(k)).length);
    }
    
    const max = Math.max(...vals, 5);
    ctx.clearRect(0,0,w,h);
    
    // Line
    ctx.beginPath(); ctx.strokeStyle = "#4f46e5"; ctx.lineWidth = 3;
    const step = (w-40)/(labs.length-1);
    vals.forEach((v,i) => {
        const x = 20 + i*step;
        const y = h - 20 - (v/max)*(h-40);
        if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        ctx.fillStyle = "#4f46e5"; ctx.fillRect(x-3, y-3, 6, 6);
        ctx.fillStyle = "#6b7280"; ctx.font="10px Arial"; ctx.fillText(labs[i].slice(5), x-10, h-5);
    });
    ctx.stroke();
}
</script>
</body>
</html><!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Admin Dashboard v3</title>

<style>
    /* --- Modern Design System --- */
    :root {
        --primary: #4f46e5; /* Indigo */
        --primary-light: #e0e7ff;
        --bg-body: #f3f4f6;
        --bg-card: #ffffff;
        --text-main: #1f2937;
        --text-sub: #6b7280;
        --danger: #ef4444;
        --success: #10b981;
        --border: #e5e7eb;
        --radius: 16px;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { background-color: var(--bg-body); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; color: var(--text-main); font-size: 15px; line-height: 1.5; padding-bottom: 80px; }

    /* --- Utilities --- */
    .d-none { display: none !important; }
    .d-flex { display: flex; }
    .flex-col { flex-direction: column; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-2 { gap: 0.5rem; }
    .gap-4 { gap: 1rem; }
    .w-full { width: 100%; }
    .font-bold { font-weight: 700; }
    .text-sm { font-size: 0.85rem; }
    .text-xs { font-size: 0.75rem; }
    .text-muted { color: var(--text-sub); }
    .text-primary { color: var(--primary); }
    .text-danger { color: var(--danger); }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .mt-4 { margin-top: 1rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .p-4 { padding: 1rem; }

    /* --- Layout --- */
    .app-layout { display: flex; min-height: 100vh; }
    
    /* Sidebar (PC) */
    .sidebar {
        width: 260px; background: #111827; color: #9ca3af;
        position: fixed; inset: 0 auto 0 0; z-index: 50;
        display: none; flex-direction: column; padding: 1.5rem;
    }
    .brand { font-size: 1.4rem; font-weight: 800; color: #fff; margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; }
    .nav-group { margin-bottom: 1.5rem; }
    .nav-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; margin-bottom: 0.5rem; color: #4b5563; }
    .nav-item {
        display: block; padding: 0.75rem 1rem; border-radius: 12px; cursor: pointer;
        transition: 0.2s; margin-bottom: 4px; font-weight: 500;
    }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .nav-item.active { background: var(--primary); color: #fff; }

    /* Main Content */
    .main { flex: 1; padding: 1.5rem; width: 100%; max-width: 1200px; margin: 0 auto; }
    
    @media (min-width: 1024px) {
        .sidebar { display: flex; }
        .main { margin-left: 260px; padding: 2rem; }
        .bottom-nav { display: none !important; }
    }

    /* --- Cards --- */
    .card {
        background: var(--bg-card); border-radius: var(--radius);
        box-shadow: var(--shadow); overflow: hidden; margin-bottom: 1.5rem;
        border: 1px solid var(--border);
    }
    .card-header {
        padding: 1rem 1.25rem; border-bottom: 1px solid var(--border);
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(255,255,255,0.5); backdrop-filter: blur(8px);
    }
    .card-title { font-weight: 700; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
    .card-body { padding: 1.25rem; }

    /* --- Stats Grid --- */
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    @media(min-width: 768px) { .stats-grid { grid-template-columns: repeat(4, 1fr); } }
    
    .stat-box {
        background: #fff; padding: 1rem; border-radius: var(--radius);
        border: 1px solid var(--border); box-shadow: var(--shadow);
        display: flex; flex-direction: column; justify-content: center;
    }
    .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--text-main); line-height: 1.2; }
    .stat-lbl { font-size: 0.75rem; font-weight: 600; color: var(--text-sub); text-transform: uppercase; }

    /* --- Forms & Inputs --- */
    .form-label { display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem; }
    .input {
        width: 100%; padding: 0.8rem; border-radius: 10px; border: 1px solid #d1d5db;
        font-size: 16px; /* iOS zoom prevent */ transition: 0.2s; background: #f9fafb;
    }
    .input:focus { outline: none; border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px var(--primary-light); }
    textarea.input { min-height: 100px; resize: vertical; }

    /* --- Buttons --- */
    .btn {
        display: inline-flex; align-items: center; justify-content: center;
        padding: 0.8rem 1.2rem; border-radius: 10px; border: none; font-weight: 600;
        cursor: pointer; transition: 0.2s; font-size: 0.95rem;
    }
    .btn:active { transform: scale(0.97); }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-dark { background: #1f2937; color: #fff; }
    .btn-ghost { background: transparent; color: var(--text-sub); border: 1px solid var(--border); }
    .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
    .btn-group { display: flex; gap: 0.5rem; background: #f3f4f6; padding: 4px; border-radius: 10px; }
    .btn-tab { flex: 1; background: transparent; border: none; padding: 6px; font-size: 0.8rem; color: #6b7280; border-radius: 8px; }
    .btn-tab.active { background: #fff; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-weight: 700; }

    /* --- Toggle Switch --- */
    .toggle-wrapper { display: flex; align-items: center; cursor: pointer; justify-content: space-between; width: 100%; padding: 0.5rem 0; }
    .toggle-track { width: 50px; height: 28px; background: #d1d5db; border-radius: 20px; position: relative; transition: 0.3s; }
    .toggle-dot { width: 22px; height: 22px; background: #fff; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    input:checked + .toggle-track { background: var(--success); }
    input:checked + .toggle-track .toggle-dot { transform: translateX(22px); }

    /* --- Tables --- */
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    table { width: 100%; border-collapse: collapse; white-space: nowrap; }
    th { text-align: left; padding: 1rem; background: #f9fafb; font-size: 0.8rem; color: var(--text-sub); border-bottom: 1px solid var(--border); }
    td { padding: 1rem; border-bottom: 1px solid #f3f4f6; }
    tr:last-child td { border-bottom: none; }
    
    /* --- Badges --- */
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }
    .badge-ok { background: #d1fae5; color: #065f46; }
    .badge-ng { background: #fee2e2; color: #991b1b; }
    .badge-neutral { background: #f3f4f6; color: #374151; }

    /* --- Bottom Nav (Mobile) --- */
    .bottom-nav {
        position: fixed; bottom: 0; left: 0; right: 0; height: 65px; background: #fff;
        border-top: 1px solid var(--border); display: flex; justify-content: space-around;
        padding-bottom: safe-area-inset-bottom; z-index: 100;
    }
    .b-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #9ca3af; font-size: 0.7rem; }
    .b-item.active { color: var(--primary); }
    .b-icon { font-size: 1.4rem; margin-bottom: 2px; }

    /* --- Modal --- */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200;
        display: none; justify-content: center; align-items: flex-end; backdrop-filter: blur(2px);
    }
    .modal-overlay.active { display: flex; }
    .modal-content {
        background: #fff; width: 100%; max-width: 600px; height: 90vh;
        border-radius: 24px 24px 0 0; padding: 1.5rem; overflow-y: auto;
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex; flex-direction: column;
    }
    @media(min-width: 600px) {
        .modal-overlay { align-items: center; }
        .modal-content { height: auto; max-height: 85vh; border-radius: 16px; width: 90%; }
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    /* --- Chart & Timeline --- */
    canvas { width: 100% !important; height: 200px !important; }
    .timeline-item { padding-left: 1.5rem; border-left: 2px solid #e5e7eb; position: relative; padding-bottom: 1.5rem; margin-left: 0.5rem; }
    .timeline-item::before { content:''; position: absolute; left: -7px; top: 0; width: 12px; height: 12px; background: #fff; border: 3px solid var(--primary); border-radius: 50%; }

    /* --- Login --- */
    #login-wrap { position: fixed; inset: 0; background: #f3f4f6; z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 1rem; }
    .login-box { background: #fff; padding: 2rem; border-radius: 16px; width: 100%; max-width: 360px; box-shadow: var(--shadow); text-align: center; }
</style>
</head>
<body>

<!-- Login -->
<div id="login-wrap">
    <div class="login-box">
        <div style="font-size:3rem; margin-bottom:0.5rem;">ğŸ”</div>
        <h2 class="font-bold mb-2">Admin Panel</h2>
        <p class="text-muted text-sm mb-4">ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="password" id="pass" class="input mb-4" style="text-align:center;" placeholder="Password">
        <button class="btn btn-primary w-full" onclick="tryLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div id="login-msg" class="text-danger text-sm mt-4 font-bold"></div>
    </div>
</div>

<!-- App Layout -->
<div id="app" class="app-layout d-none">
    
    <!-- PC Sidebar -->
    <nav class="sidebar">
        <div class="brand">ğŸ“Š Admin v3</div>
        <div class="nav-group">
            <div class="nav-label">Main</div>
            <a class="nav-item active" onclick="nav('dash')">ğŸ  ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            <a class="nav-item" onclick="nav('users')">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
            <a class="nav-item" onclick="nav('feed')">ğŸ’¬ å—ä¿¡ãƒˆãƒ¬ã‚¤</a>
        </div>
        <div class="nav-group">
            <div class="nav-label">Settings</div>
            <a class="nav-item" onclick="nav('notif')">ğŸ“¢ ãŠçŸ¥ã‚‰ã›è¨­å®š</a>
            <a class="nav-item" onclick="nav('survey')">ğŸ“ ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</a>
        </div>
        <div class="nav-group">
            <div class="nav-label">Content</div>
            <a class="nav-item" onclick="nav('upd')">ğŸ”„ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ</a>
            <a class="nav-item" onclick="nav('sch')">ğŸ“… äºˆå®šè¡¨</a>
        </div>
        <div style="margin-top:auto">
            <button class="btn btn-ghost w-full" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main">
        
        <!-- DASHBOARD -->
        <div id="view-dash" class="view">
            <div class="d-flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
                <div class="text-xs text-muted" id="last-sync">Syncing...</div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-lbl">Online</div>
                    <div class="stat-val text-primary" id="s-online">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-lbl">Users</div>
                    <div class="stat-val" id="s-total">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-lbl">Feedback</div>
                    <div class="stat-val" id="s-feed">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-lbl">Answers</div>
                    <div class="stat-val" id="s-ans">-</div>
                </div>
            </div>

            <div class="d-flex flex-col gap-4" style="flex-direction: column-reverse; md:flex-row;">
                <!-- Chart -->
                <div class="card w-full">
                    <div class="card-header"><span class="card-title">ğŸ“ˆ æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ (6ãƒ¶æœˆ)</span></div>
                    <div class="card-body">
                        <canvas id="chart"></canvas>
                    </div>
                </div>

                <!-- Ranking -->
                <div class="card w-full">
                    <div class="card-header">
                        <span class="card-title">ğŸ† äººæ°—ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
                    </div>
                    <div class="p-4 bg-white" style="border-bottom:1px solid var(--border);">
                        <!-- Ranking Tabs -->
                        <div class="btn-group">
                            <button class="btn-tab active" onclick="setRankMode('month', this)">ä»Šæœˆ</button>
                            <button class="btn-tab" onclick="setRankMode('half', this)">ç›´è¿‘6ãƒ¶æœˆ</button>
                            <button class="btn-tab" onclick="setRankMode('all', this)">ç·åˆ</button>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table class="table">
                            <tbody id="rank-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><span class="card-title">âš¡ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</span></div>
                <div class="card-body" id="timeline"></div>
            </div>
        </div>

        <!-- NOTIFICATION -->
        <div id="view-notif" class="view d-none">
            <h2 class="font-bold text-lg mb-4">ãŠçŸ¥ã‚‰ã›è¨­å®š</h2>
            <div class="card" style="max-width: 600px; margin:0 auto;">
                <div class="card-body">
                    <!-- Toggle Switch -->
                    <label class="toggle-wrapper mb-4">
                        <div>
                            <div class="font-bold">ãŠçŸ¥ã‚‰ã›æ©Ÿèƒ½ã®æœ‰åŠ¹åŒ–</div>
                            <div class="text-xs text-muted">ONã«ã™ã‚‹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨ªå•æ™‚ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
                        </div>
                        <div style="position:relative;">
                            <input type="checkbox" id="n-active" class="d-none">
                            <div class="toggle-track"><div class="toggle-dot"></div></div>
                        </div>
                    </label>
                    <hr class="mb-4" style="border:none; border-top:1px solid #eee;">
                    
                    <div class="mb-4">
                        <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input id="n-title" class="input" placeholder="ä¾‹: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›">
                    </div>
                    <div class="mb-4">
                        <label class="form-label">æœ¬æ–‡ (<span class="text-danger">#æ–‡å­—#</span>ã§èµ¤è‰²å¼·èª¿)</label>
                        <textarea id="n-text" class="input" placeholder="æœ¬æ–‡ã‚’å…¥åŠ›..."></textarea>
                    </div>
                    <button class="btn btn-primary w-full" onclick="saveNotif()">è¨­å®šã‚’ä¿å­˜ã—ã¦å…¬é–‹</button>
                </div>
            </div>
        </div>

        <!-- SURVEY -->
        <div id="view-survey" class="view d-none">
            <h2 class="font-bold text-lg mb-4">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆç®¡ç†</h2>
            
            <div class="btn-group mb-4" style="max-width:400px;">
                <button class="btn-tab active" onclick="switchSurveyView('current', this)">ç¾åœ¨ã®è¨­å®š</button>
                <button class="btn-tab" onclick="switchSurveyView('history', this)">éå»ã®é›†è¨ˆå±¥æ­´</button>
            </div>

            <!-- Current Survey -->
            <div id="sv-current">
                <div class="d-flex flex-col gap-4">
                    <div class="card">
                        <div class="card-header font-bold">æ–°è¦ä½œæˆ / æ›´æ–°</div>
                        <div class="card-body">
                            <div class="text-xs text-danger mb-2 p-2" style="background:#fee2e2; border-radius:8px;">âš ï¸ å…¬é–‹ã™ã‚‹ã¨ç¾åœ¨ã®é›†è¨ˆã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</div>
                            <label class="form-label">è³ªå•æ–‡</label>
                            <input id="sv-q" class="input mb-3" placeholder="è³ªå•...">
                            <label class="form-label">é¸æŠè‚¢ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
                            <input id="sv-o" class="input mb-4" placeholder="ä¾‹: A,B,C">
                            <button class="btn btn-primary w-full" onclick="pubSurvey()">å…¬é–‹ã™ã‚‹</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header font-bold">ç¾åœ¨ã®é›†è¨ˆçµæœ</div>
                        <div class="card-body">
                            <div class="mb-2"><span class="badge badge-neutral">è³ªå•</span> <span id="sv-cur-q" class="font-bold">-</span></div>
                            <hr class="mb-4" style="border:0; border-top:1px solid #eee;">
                            <div id="sv-res-area"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Survey History -->
            <div id="sv-history" class="d-none">
                <div id="sv-hist-list" class="d-flex flex-col gap-4"></div>
            </div>
        </div>

        <!-- USERS -->
        <div id="view-users" class="view d-none">
            <h2 class="font-bold text-lg mb-4">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h2>
            <div class="card mb-4">
                <div class="card-body p-2">
                    <input id="u-search" class="input" placeholder="ğŸ” åå‰ã€IDã€ãƒ¡ãƒ¢ã§æ¤œç´¢..." onkeyup="filterUsers()">
                </div>
            </div>
            <div class="card">
                <div class="table-wrap">
                    <table class="table">
                        <thead><tr><th>Status</th><th>Name / ID</th><th>Last Login</th><th>Memo</th><th>Action</th></tr></thead>
                        <tbody id="u-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- OTHERS (Simplified) -->
        <div id="view-feed" class="view d-none">
            <h2 class="font-bold text-lg mb-4">å—ä¿¡ãƒˆãƒ¬ã‚¤</h2>
            <div class="card"><div class="table-wrap"><table class="table"><tbody id="feed-list"></tbody></table></div></div>
        </div>
        <div id="view-upd" class="view d-none">
            <h2 class="font-bold text-lg mb-4">ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆç®¡ç†</h2>
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex gap-2 mb-2">
                        <input id="up-v" class="input" placeholder="Ver (v1.0)" style="flex:1">
                        <input id="up-d" class="input" placeholder="æ—¥ä»˜" style="flex:1">
                    </div>
                    <input id="up-t" class="input mb-2" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
                    <input id="up-vid" class="input mb-2" placeholder="å‹•ç”»URL">
                    <textarea id="up-det" class="input mb-2" placeholder="è©³ç´°"></textarea>
                    <button class="btn btn-dark w-full" onclick="addUp()">è¿½åŠ </button>
                </div>
            </div>
            <div class="card"><div class="table-wrap"><table class="table"><tbody id="up-list"></tbody></table></div></div>
        </div>
        <div id="view-sch" class="view d-none">
             <h2 class="font-bold text-lg mb-4">äºˆå®šç®¡ç†</h2>
             <div class="card mb-4">
                <div class="card-body">
                    <input id="sc-n" class="input mb-2" placeholder="äºˆå®šå">
                    <input id="sc-d" class="input mb-2" placeholder="æ—¥æ™‚">
                    <button class="btn btn-dark w-full" onclick="addSch()">è¿½åŠ </button>
                </div>
            </div>
            <div class="card"><div class="table-wrap"><table class="table"><tbody id="sch-list"></tbody></table></div></div>
        </div>

    </main>

    <!-- Mobile Bottom Nav -->
    <nav class="bottom-nav">
        <div class="b-item active" onclick="nav('dash',this)"><span class="b-icon">ğŸ </span><span>Home</span></div>
        <div class="b-item" onclick="nav('users',this)"><span class="b-icon">ğŸ‘¥</span><span>Users</span></div>
        <div class="b-item" onclick="nav('notif',this)"><span class="b-icon">ğŸ“¢</span><span>Info</span></div>
        <div class="b-item" onclick="nav('survey',this)"><span class="b-icon">ğŸ“</span><span>Poll</span></div>
    </nav>

</div>

<!-- USER MODAL -->
<div class="modal-overlay" id="uModal">
    <div class="modal-content">
        <div class="d-flex justify-between items-center mb-4">
            <h3 class="font-bold text-lg">ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°</h3>
            <button onclick="closeModal('uModal')" class="btn btn-ghost" style="font-size:1.5rem; padding:0 10px;">Ã—</button>
        </div>
        <div class="d-flex items-center gap-4 mb-4">
            <div id="m-av" style="width:60px; height:60px; background:var(--primary); color:#fff; border-radius:50%; display:flex; items-center; justify-center; font-size:1.5rem; font-weight:bold; display:flex; align-items:center; justify-content:center;">U</div>
            <div style="flex:1; overflow:hidden;">
                <div id="m-name" class="font-bold text-lg">Name</div>
                <div id="m-id" class="text-xs text-muted">ID</div>
            </div>
            <div id="m-badge"></div>
        </div>
        
        <div class="d-flex gap-2 mb-4 text-center bg-gray-50 p-2 rounded" style="background:#f9fafb; border-radius:12px;">
            <div class="w-full">
                <div class="text-xs text-muted">åˆå›</div>
                <div id="m-reg" class="font-bold text-sm">-</div>
            </div>
            <div class="w-full">
                <div class="text-xs text-muted">ãƒ—ãƒ¬ã‚¤æ•°</div>
                <div id="m-play" class="font-bold text-sm">0</div>
            </div>
        </div>

        <div class="mb-4">
            <label class="form-label">ç®¡ç†è€…ãƒ¡ãƒ¢</label>
            <input id="m-memo" class="input" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›...">
        </div>
        
        <div class="mb-4">
            <label class="form-label">ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ (BAN)</label>
            <div class="btn-group">
                <button class="btn-tab active" id="btn-ban-false" onclick="setBanUI(false)">è¨±å¯ (é€šå¸¸)</button>
                <button class="btn-tab" id="btn-ban-true" onclick="setBanUI(true)">ç¦æ­¢ (BAN)</button>
            </div>
            <input type="hidden" id="m-ban-val">
        </div>

        <div class="mb-4">
            <label class="form-label">å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
            <input id="m-msg" class="input" placeholder="æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«è¡¨ç¤ºã•ã‚Œã¾ã™">
        </div>
        
        <button class="btn btn-primary w-full mb-4" onclick="saveUser()">ä¿å­˜ã™ã‚‹</button>

        <hr class="mb-4" style="border:0; border-top:1px solid #eee;">
        <h4 class="font-bold text-sm mb-2">ãƒ—ãƒ¬ã‚¤å±¥æ­´ (Top 5)</h4>
        <ul id="m-hist" class="text-sm text-muted" style="padding-left:1.2rem;"></ul>
    </div>
</div>

<script>
/* --- LOGIC --- */
const API = "https://script.google.com/macros/s/AKfycbzJSO_Bq80Qc1UI8RNyKBJ2Az81QfFkqdO-0j9nLglrEkirg-69sxYfPdGMbq9l30AO/exec";
let auth="", data=null, timer=null;
let rankMode = "month"; // month, half, all
let curUser = null;

const dom = (id) => document.getElementById(id);
const hide = (id) => dom(id).classList.add("d-none");
const show = (id) => dom(id).classList.remove("d-none");

/* Init */
window.onload = () => {
    const key = localStorage.getItem("admKey");
    if(key) { dom("pass").value = key; tryLogin(); }
};

async function tryLogin() {
    const p = dom("pass").value;
    if(!p) return;
    dom("login-msg").innerText = "èªè¨¼ä¸­...";
    try {
        const r = await fetch(API, { method:"POST", body:JSON.stringify({ action:"adminGetData", payload:{ password:p } }) });
        const j = await r.json();
        if(j.status === "success") {
            auth = p; data = j.data;
            localStorage.setItem("admKey", p);
            hide("login-wrap"); show("app");
            renderAll();
            timer = setInterval(fetchData, 15000);
        } else {
            dom("login-msg").innerText = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™";
            localStorage.removeItem("admKey");
        }
    } catch(e) { dom("login-msg").innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼"; }
}

async function fetchData() {
    if(document.querySelector(".modal-overlay.active")) return; // ãƒ¢ãƒ¼ãƒ€ãƒ«ä¸­ã¯æ›´æ–°ã—ãªã„
    try {
        const r = await fetch(API, { method:"POST", body:JSON.stringify({ action:"adminGetData", payload:{ password:auth } }) });
        const j = await r.json();
        if(j.status==="success") { data = j.data; renderAll(); }
    } catch(e){}
}

/* Rendering Main */
function renderAll() {
    if(!data) return;
    const now = new Date();
    
    // Stats
    const threshold = 10 * 60 * 1000; // 10 min
    const online = data.users.filter(u => u[2] && (now - new Date(u[2]).getTime() < threshold)).length;
    dom("s-online").innerText = online;
    dom("s-total").innerText = data.users.length;
    dom("s-feed").innerText = data.feedback.length;
    dom("s-ans").innerText = data.surveyResponses.length;
    dom("last-sync").innerText = now.getHours()+":"+String(now.getMinutes()).padStart(2,"0")+" æ›´æ–°";

    // Chart
    drawChart();

    // Ranking (Refresh based on current mode)
    renderRank();

    // Timeline
    let feed = [];
    data.users.forEach(u => feed.push({t:new Date(u[1]), txt:`New User: ${u[0].slice(0,5)}...`}));
    data.feedback.forEach(f => feed.push({t:new Date(f[0]), txt:`Feedback: ${f[3]}`}));
    feed.sort((a,b)=>b.t-a.t);
    dom("timeline").innerHTML = feed.slice(0,8).map(x=>
        `<div class="timeline-item"><div class="text-xs text-muted">${x.t.getMonth()+1}/${x.t.getDate()} ${x.t.getHours()}:${String(x.t.getMinutes()).padStart(2,"0")}</div><div class="text-sm">${x.txt}</div></div>`
    ).join("");

    // Notification Form
    // ç¢ºå®Ÿã«æ–‡å­—åˆ—ã¨ã—ã¦æ¯”è¼ƒ
    const nActive = String(data.config.notificationActive).toUpperCase() === "TRUE";
    dom("n-active").checked = nActive;
    dom("n-title").value = data.config.notificationTitle || "";
    dom("n-text").value = (data.config.notificationText || "").replaceAll("<br>","\n");

    // Survey
    const q = data.config.surveyQuestion || "(æœªè¨­å®š)";
    dom("sv-cur-q").innerText = q;
    renderSurveyRes(q, "sv-res-area");
    renderSurveyHistory();

    // Users
    renderUsers();

    // Others
    renderList("feed-list", data.feedback, r => `<td>${r[0].slice(5,16)}</td><td><div class="font-bold">${r[2]}</div><div class="text-xs text-muted">${r[1]}</div></td><td>${r[3]}</td><td style="white-space:normal">${r[7]}</td>`);
    renderList("up-list", data.updates, (r,i) => `<td>${r[0]}</td><td>${r[1]}</td><td style="white-space:normal">${r[2]}</td><td><button class="btn btn-sm text-danger" onclick="del('Updates',${i})">Ã—</button></td>`);
    renderList("sch-list", data.schedule, (r,i) => `<td>${r[0]}</td><td>${r[1]}</td><td><button class="btn btn-sm text-danger" onclick="del('Schedule',${i})">Ã—</button></td>`);
}

/* Rank Logic */
function setRankMode(m, el) {
    rankMode = m;
    el.parentNode.querySelectorAll(".btn-tab").forEach(b=>b.classList.remove("active"));
    el.classList.add("active");
    renderRank();
}

function renderRank() {
    const now = new Date();
    let limitDate = new Date(0); // All time

    if(rankMode === 'month') limitDate = new Date(now.getFullYear(), now.getMonth(), 1);
    else if(rankMode === 'half') limitDate = new Date(now.getFullYear(), now.getMonth()-6, 1);

    const counts = {};
    data.playLogs.forEach(l => {
        const d = new Date(l[0].replace(/-/g,'/'));
        if(d >= limitDate) counts[l[2]] = (counts[l[2]]||0)+1;
    });

    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const html = sorted.length ? sorted.map((x,i)=>
        `<tr><td class="font-bold">${i+1}</td><td>${x[0]}</td><td class="text-right font-bold">${x[1]}</td></tr>`
    ).join("") : `<tr><td colspan="3" class="text-center text-muted p-4">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>`;
    
    dom("rank-body").innerHTML = html;
}

/* Survey Logic */
function renderSurveyRes(quest, targetId) {
    const box = dom(targetId); box.innerHTML = "";
    if(!quest || quest==="(æœªè¨­å®š)") { box.innerHTML="<div class='text-center text-muted'>ãƒ‡ãƒ¼ã‚¿ãªã—</div>"; return; }
    
    const cnt = {}; let total = 0;
    data.surveyResponses.forEach(r => {
        if(r[3] === quest) { cnt[r[4]] = (cnt[r[4]]||0)+1; total++; }
    });

    if(total===0) { box.innerHTML="<div class='text-center text-muted'>å›ç­”ãªã—</div>"; return; }

    Object.keys(cnt).forEach(ans => {
        const pct = Math.round(cnt[ans]/total*100);
        box.innerHTML += `
            <div class="mb-2">
                <div class="d-flex justify-between text-sm mb-1"><span>${ans}</span><span>${cnt[ans]} (${pct}%)</span></div>
                <div style="background:#f3f4f6; height:8px; border-radius:4px; overflow:hidden;">
                    <div style="background:var(--primary); width:${pct}%; height:100%;"></div>
                </div>
            </div>`;
    });
}

function renderSurveyHistory() {
    // Group by question
    const qs = {};
    data.surveyResponses.forEach(r => {
        const q = r[3];
        if(!qs[q]) qs[q] = { last: r[0], count: 0 };
        qs[q].count++;
        if(new Date(r[0]) > new Date(qs[q].last)) qs[q].last = r[0];
    });

    const list = Object.entries(qs).sort((a,b)=> new Date(b[1].last) - new Date(a[1].last));
    
    const container = dom("sv-hist-list"); container.innerHTML = "";
    list.forEach(([qText, info]) => {
        const uid = "sv-h-"+Math.random().toString(36).substr(2,9);
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
            <div class="card-header" style="cursor:pointer;" onclick="document.getElementById('${uid}').classList.toggle('d-none')">
                <div>
                    <div class="font-bold text-sm">${qText}</div>
                    <div class="text-xs text-muted">Last: ${info.last.slice(0,10)} / Total: ${info.count}</div>
                </div>
                <div>â–¼</div>
            </div>
            <div class="card-body d-none" id="${uid}"></div>
        `;
        container.appendChild(div);
        renderSurveyRes(qText, uid); // Render bars inside
    });
}

function switchSurveyView(mode, btn) {
    if(mode==='current'){ show('sv-current'); hide('sv-history'); }
    else { hide('sv-current'); show('sv-history'); }
    btn.parentNode.querySelectorAll(".btn-tab").forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
}

/* User Management */
function renderUsers() {
    const list = dom("u-list"); list.innerHTML = "";
    const nameMap = {}; data.feedback.forEach(f=>nameMap[f[1]]=f[2]);

    [...data.users].reverse().forEach(u => {
        const [uid, reg, acc, ban, msg, memo] = u;
        const name = nameMap[uid] || "No Name";
        const isBan = String(ban).toUpperCase() === "TRUE";
        const isOnline = acc && (new Date() - new Date(acc) < 10*60*1000);
        
        const badge = isBan ? `<span class="badge badge-ng">BAN</span>` : (isOnline ? `<span class="badge badge-ok">Online</span>` : `<span class="badge badge-neutral">Offline</span>`);
        
        const tr = document.createElement("tr");
        tr.className = "u-row";
        tr.dataset.s = (uid+name+(memo||"")).toLowerCase();
        tr.innerHTML = `
            <td>${badge}</td>
            <td><div class="font-bold">${name}</div><div class="text-xs text-muted">${uid}</div></td>
            <td>${acc ? acc.slice(5,16) : '-'}</td>
            <td style="max-width:100px; overflow:hidden; text-overflow:ellipsis;">${memo||""}</td>
            <td><button class="btn btn-sm btn-ghost" onclick="openUser('${uid}')">è©³ç´°</button></td>
        `;
        list.appendChild(tr);
    });
    filterUsers();
}

function filterUsers() {
    const k = dom("u-search").value.toLowerCase();
    document.querySelectorAll(".u-row").forEach(r => {
        r.style.display = r.dataset.s.includes(k) ? "" : "none";
    });
}

function openUser(uid) {
    const u = data.users.find(x=>x[0]===uid);
    curUser = u;
    const name = data.feedback.find(f=>f[1]===uid)?.[2] || "No Name";
    
    dom("m-name").innerText = name;
    dom("m-id").innerText = uid;
    dom("m-av").innerText = name.charAt(0);
    dom("m-reg").innerText = u[1] ? u[1].slice(0,10) : "-";
    dom("m-memo").value = u[5] || "";
    dom("m-msg").value = u[4] || "";
    
    // BAN UI
    const isBan = String(u[3]).toUpperCase() === "TRUE";
    setBanUI(isBan);
    dom("m-badge").innerHTML = isBan ? `<span class="badge badge-ng">åœæ­¢ä¸­</span>` : `<span class="badge badge-ok">æœ‰åŠ¹</span>`;

    // History
    const logs = data.playLogs.filter(l=>l[1]===uid);
    dom("m-play").innerText = logs.length;
    const cnt = {}; logs.forEach(l=>cnt[l[2]]=(cnt[l[2]]||0)+1);
    const sorted = Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,5);
    dom("m-hist").innerHTML = sorted.length ? sorted.map(x=>`<li>${x[0]} (${x[1]})</li>`).join("") : "<li>å±¥æ­´ãªã—</li>";

    dom("uModal").classList.add("active");
}

function setBanUI(isBan) {
    dom("m-ban-val").value = isBan ? "TRUE" : "FALSE";
    if(isBan) {
        dom("btn-ban-true").classList.add("active");
        dom("btn-ban-false").classList.remove("active");
    } else {
        dom("btn-ban-true").classList.remove("active");
        dom("btn-ban-false").classList.add("active");
    }
}

/* Actions */
async function post(act, py) {
    py.password = auth;
    const btn = document.querySelector("button:active") || document.body;
    const oldText = btn.innerText;
    if(btn.tagName==="BUTTON") btn.innerText = "...";
    
    try {
        await fetch(API, { method:"POST", body:JSON.stringify({ action:act, payload:py }) });
        await fetchData();
        alert("å®Œäº†ã—ã¾ã—ãŸ");
    } catch(e) { alert("ã‚¨ãƒ©ãƒ¼"); }
    
    if(btn.tagName==="BUTTON") btn.innerText = oldText;
}

function saveNotif() {
    const active = dom("n-active").checked ? "TRUE" : "FALSE";
    const title = dom("n-title").value;
    const text = dom("n-text").value.replaceAll("\n", "<br>");
    post("adminSaveConfigBatch", { data: { notificationActive: active, notificationTitle: title, notificationText: text } });
}

function saveUser() {
    post("adminUpdateUser", { 
        userId: curUser[0], 
        banStatus: dom("m-ban-val").value, 
        message: dom("m-msg").value, 
        memo: dom("m-memo").value 
    });
    closeModal('uModal');
}

function pubSurvey() {
    const q = dom("sv-q").value;
    const o = dom("sv-o").value;
    if(q && confirm("å…¬é–‹ã—ã¾ã™ã‹ï¼Ÿ")) {
        post("adminSaveConfigBatch", { data: { surveyId: "S"+Date.now(), surveyQuestion: q, surveyOptions: o } });
    }
}

function addUp() {
    const p = { version: dom("up-v").value, date: dom("up-d").value, title: dom("up-t").value, details: dom("up-det").value, videoUrl: dom("up-vid").value };
    if(p.version) post("adminAddUpdate", p);
}
function addSch() { post("adminAddSchedule", { name: dom("sc-n").value, date: dom("sc-d").value }); }
function del(s,i) { if(confirm("å‰Šé™¤?")) post("adminDeleteRow", { sheetName:s, rowIndex:i }); }

/* Helper */
function renderList(id, arr, fn) { dom(id).innerHTML = arr.map((r,i) => `<tr>${fn(r,i)}</tr>`).join(""); }
function nav(id, el) {
    document.querySelectorAll(".view").forEach(v=>v.classList.add("d-none"));
    show("view-"+id);
    document.querySelectorAll(".nav-item, .b-item").forEach(x=>x.classList.remove("active"));
    if(el) el.classList.add("active"); // Mobile
    // Desktop Sync
    const dLink = document.querySelector(`.nav-item[onclick*="${id}"]`);
    if(dLink) dLink.classList.add("active");
}
function closeModal(id) { dom(id).classList.remove("active"); }
function logout() { localStorage.removeItem("admKey"); location.reload(); }

/* Simple Chart */
function drawChart() {
    const cvs = dom("chart");
    const ctx = cvs.getContext("2d");
    cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight;
    const w = cvs.width, h = cvs.height;
    
    // Last 6 months
    const labs = [], vals = [];
    for(let i=5; i>=0; i--) {
        const d = new Date(); d.setMonth(d.getMonth()-i);
        const k = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        labs.push(k);
        vals.push(data.users.filter(u=> u[1] && u[1].startsWith(k)).length);
    }
    
    const max = Math.max(...vals, 5);
    ctx.clearRect(0,0,w,h);
    
    // Line
    ctx.beginPath(); ctx.strokeStyle = "#4f46e5"; ctx.lineWidth = 3;
    const step = (w-40)/(labs.length-1);
    vals.forEach((v,i) => {
        const x = 20 + i*step;
        const y = h - 20 - (v/max)*(h-40);
        if(i==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        ctx.fillStyle = "#4f46e5"; ctx.fillRect(x-3, y-3, 6, 6);
        ctx.fillStyle = "#6b7280"; ctx.font="10px Arial"; ctx.fillText(labs[i].slice(5), x-10, h-5);
    });
    ctx.stroke();
}
</script>
</body>
</html>
